(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
(function (global){(function (){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Atom=require("./lib/atom.js"),IconRenderer=require("./lib/icon_renderer.js"),PanelManager=require("./lib/panels/manager.js"),Component=require("./lib/component.js"),EventEmitter=require("events"),Sound=require("./lib/sound.js"),Matrix=require("./lib/matrix.js"),{Eye:Eye,Plane:Plane}=require("./lib/eye.js"),localClient=0;class TypespessClient extends EventEmitter{constructor(e,t=""){super(),e||(e="ws"+window.location.origin.substring(4)),this.resRoot=t,this.wsurl=e,this.atoms_by_netid={},this.atoms=[],this.visible_tiles=new Set,this.dirty_atoms=[],this.glide_size=10,this.icon_meta_load_queue={},this.icon_metas={},this.components={},this.panel_classes={},this.eyes={},this.server_time_to_client=0,this.audio_buffers=new Map,this.playing_sounds=new Map,this.soft_shadow_resolution=8,!global.is_bs_editor_env&&global.AudioContext&&(this.audio_ctx=new AudioContext),this.importModule(require("./lib/lighting.js"))}handle_login(){this.connection.send(JSON.stringify({login:"guest"+Math.floor(1e6*Math.random())})),this.login_finish()}handle_server(){localClient?this.panel_manager.create_client_panel({title:"Choose a Server",can_close:!1,content_class:"ServerPanel",width:400,height:250}):this.resume_login("localhost")}login(){if(global.is_bs_editor_env)throw new Error("Client should not be started in editor mode");this.panel_manager=new PanelManager(this),this.handle_server()}resume_login(e="localhost"){localClient&&(this.wsurl=`ws://${e}:1713`),this.connection=new WebSocket(this.wsurl),this.connection.addEventListener("open",()=>{this.handle_login()}),window.addEventListener("mousedown",()=>{this.audio_ctx.resume()},{once:!0})}login_finish(){if(global.is_bs_editor_env)throw new Error("Client should not be started in editor mode");this.connection.addEventListener("message",this.handleSocketMessage.bind(this)),requestAnimationFrame(this.anim_loop.bind(this));const e=new Set;document.addEventListener("keydown",t=>{"input"!==t.target.localName&&this.connection&&(e.add(t.key),this.connection.send(JSON.stringify({keydown:{key:t.key,id:t.target.id}})))}),document.addEventListener("keyup",t=>{("input"!==t.target.localName&&this.connection||e.has(t.key))&&(e.delete(t.key),this.connection.send(JSON.stringify({keyup:{key:t.key,id:t.target.id}})))}),window.addEventListener("blur",()=>{for(const t of e)this.connection.send(JSON.stringify({keyup:{key:t}})),e.delete(t)})}importModule(e){if(e.components)for(const t in e.components)if(Object.prototype.hasOwnProperty.call(e.components,t)){if(this.components[t])throw new Error(`Component ${t} already exists!`);if(e.components[t].name!==t)throw new Error(`Component name mismatch! Named ${t} in map and constructor is named ${e.components[t].name}`);this.components[t]=e.components[t]}if(e.panel_classes)for(const t in e.panel_classes)if(Object.prototype.hasOwnProperty.call(e.panel_classes,t)){if(this.panel_classes[t])throw new Error(`Panel class ${t} already exists!`);if(e.panel_classes[t].name!==t)throw new Error(`Panel class name mismatch! Named ${t} in map and constructor is named ${e.panel_classes[t].name}`);this.panel_classes[t]=e.panel_classes[t]}e.now instanceof Function&&e.now(this)}update_atoms(e,t){for(let n=0;n<e.update_atoms.length;n++){const o=e.update_atoms[n],s=this.atoms_by_netid[o.network_id];if(!s)continue;const i=s.x,a=s.y;for(const e in o)Object.prototype.hasOwnProperty.call(o,e)&&"appearance"!==e&&"network_id"!==e&&"overlays"!==e&&"components"!==e&&(s[e]=o[e]);if(s.glide=new Atom.Glide(s,{oldx:i,oldy:a,lasttime:t}),o.overlays)for(const e in o.overlays)Object.prototype.hasOwnProperty.call(o.overlays,e)&&s.set_overlay(e,o.overlays[e]);o.components&&this.update_components(o,s)}}update_components(e,t){for(const n in e.components)if(Object.prototype.hasOwnProperty.call(e.components,n))for(const o in e.components[n])Object.prototype.hasOwnProperty.call(e.components[n],o)&&(t.components[n][o]=e.components[n][o])}delete_atoms(e){for(let t=0;t<e.delete_atoms.length;t++){const n=this.atoms_by_netid[e.delete_atoms[t]];n&&n.del()}}update_eye(e,t){for(const[n,o]of Object.entries(e.eye)){const e=this.eyes[n];if(!e)continue;const s=e.origin.x,i=e.origin.y;Object.assign(e.origin,o),e.origin.glide=new Atom.Glide(e.origin,{oldx:s,oldy:i,lasttime:t})}}to_chat(e){const t=document.getElementById("chatwindow");let n=!1;t.scrollTop+t.clientHeight>=t.scrollHeight&&(n=!0);for(const t of e.to_chat){const e=document.createElement("div");e.innerHTML=t,document.getElementById("chatwindow").appendChild(e)}n&&(t.scrollTop=t.scrollHeight-t.clientHeight)}handleSocketMessage(e){const t=JSON.parse(e.data),n=performance.now();if(t.create_atoms)for(let e=0;e<t.create_atoms.length;e++)new Atom(this,t.create_atoms[e]);if(t.update_atoms&&this.update_atoms(t,n),t.delete_atoms&&this.delete_atoms(t),t.timestamp&&(this.server_time_to_client=n-t.timestamp),t.add_tiles)for(const e of t.add_tiles)this.visible_tiles.add(e);if(t.remove_tiles)for(const e of t.remove_tiles)this.visible_tiles.delete(e);if(t.eye&&this.update_eye(t,n),t.to_chat&&this.to_chat(t),t.panel&&this.panel_manager.handle_message(t.panel),t.sound){if(t.sound.play)for(const e of t.sound.play)this.playing_sounds.get(e.id)||new Sound(this,e).start();if(t.sound.stop)for(const e of t.sound.stop){const t=this.playing_sounds.get(e);t&&t.stop()}}return this.atoms.sort(Atom.atom_comparator),t}}const _chain_parent=Symbol("_chain_parent"),_chain_spliced=Symbol("_chain_spliced");TypespessClient.chain_func=function(e,t){if(void 0===t)throw new Error("Chaining undefined function!");function n(...e){for(;n[_chain_parent]&&n[_chain_parent][_chain_spliced];)n[_chain_parent]=n[_chain_parent][_chain_parent];const o=(...t)=>{if(n[_chain_parent])return t.length?n[_chain_parent].call(this,...t):n[_chain_parent].call(this,...e)};return n[_chain_spliced]?o():t.call(this,o,...e)}return n.splice=function(){n[_chain_spliced]=!0},n[_chain_spliced]=!1,n[_chain_parent]=e,n},TypespessClient.dropdown=function(e,t,{point:n=[],autoremove:o=!0}={}){let s;s=n?{x:n[0],y:n[1],width:0,height:0,left:n[0],right:n[0],top:n[1],bottom:n[1]}:e.getBoundingClientRect();const[i,a]=[document.documentElement.clientWidth,document.documentElement.clientHeight];t.style.position="fixed",t.style.visibility="hidden",e.appendChild(t);const l=t.getBoundingClientRect();let r=!1,c=!1;const d=e.classList.contains("dropdown-item");(d?s.right:s.left)+l.width>=i-10&&(r=!0),(d?s.top:s.bottom)+l.height>=a-10&&(d?s.top:s.bottom)>=i/2&&(c=!0);const p=d&&!r?s.right:s.left,h=d||c?s.top:s.bottom;r?(t.style.right=i-p+"px",t.style.maxWidth=p-10+"px"):(t.style.left=p+"px",t.style.maxWidth=i-p-10+"px"),c?(t.style.bottom=a-h+"px",t.style.maxHeight=h-10+"px"):(t.style.top=h+"px",t.style.maxHeight=a-h-10+"px"),!d&&s.width&&(t.style.minWidth=s.width+"px"),o&&(t.tabIndex=-1,t.dataset.hasDropdownFocusoutListener||(t.dataset.hasDropdownFocusoutListener=!0,t.addEventListener("focusout",()=>{setTimeout(()=>{t!==document.activeElement&&!t.contains(document.activeElement)&&e.contains(t)&&e.removeChild(t)},0)}))),t.style.visibility="",o&&t.focus()},TypespessClient.prototype.enqueue_icon_meta_load=require("./lib/icon_loader.js"),TypespessClient.prototype.anim_loop=require("./lib/renderer.js"),TypespessClient.prototype.get_audio_buffer=require("./lib/audio_loader.js"),TypespessClient.Atom=Atom,TypespessClient.Component=Component,TypespessClient.IconRenderer=IconRenderer,TypespessClient.Sound=Sound,TypespessClient.Matrix=Matrix,TypespessClient.Eye=Eye,TypespessClient.Plane=Plane,module.exports=TypespessClient;

}).call(this)}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./lib/atom.js":2,"./lib/audio_loader.js":3,"./lib/component.js":4,"./lib/eye.js":5,"./lib/icon_loader.js":6,"./lib/icon_renderer.js":7,"./lib/lighting.js":8,"./lib/matrix.js":9,"./lib/panels/manager.js":10,"./lib/renderer.js":12,"./lib/sound.js":13,"events":36}],2:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const IconRenderer=require("./icon_renderer.js"),Matrix=require("./matrix.js"),EventEmitter=require("events");class Atom extends EventEmitter{constructor(e,t){super(),Object.prototype.hasOwnProperty.call(t,"x")||(t.x=0),Object.prototype.hasOwnProperty.call(t,"y")||(t.y=0),this.client=e,this.directional=t.directional,this.main_icon_renderer=new IconRenderer(this),this.overlays={},this.overlay_renderers_list=[],this.overlay_renderers={};for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&"overlays"!==e&&"components"!==e&&"component_vars"!==e&&(this[e]=t[e]);if(this.is_destroyed=!1,this.client.atoms.push(this),this.network_id&&(this.client.atoms_by_netid[this.network_id]=this),this.eye_id=t.eye_id||"",this.eye=e.eyes[this.eye_id],this.eye&&this.eye.atoms.add(this),this.mark_dirty(),t.overlays)for(const e in t.overlays)Object.prototype.hasOwnProperty.call(t.overlays,e)&&this.set_overlay(e,t.overlays[e]);this.components={};for(const r of t.components||[]){if(!Object.prototype.hasOwnProperty.call(e.components,r)){console.warn(`Server passed an unknown networked component '${r}'! Yell at the devs of your server.`);continue}const i=e.components[r];this.components[r]=new i(this,t.component_vars?t.component_vars[r]:{})}}del(){if(this.is_destroyed=!0,this.eye){this.eye.atoms.delete(this);const e=this.get_plane();e&&e.atoms.delete(this)}this.client.atoms.splice(this.client.atoms.indexOf(this),1),delete this.client.atoms_by_netid[this.network_id];for(const e of Object.values(this.components)){e.destroy()}}get_plane_id(){return null!=this.screen_loc_x||null!=this.screen_loc_y?"ui":""}get_plane(){return this.eye&&this.eye.planes.get(this.get_plane_id())}mark_dirty(){const e=this.get_plane();e&&e.dirty_atoms.add(this)}set_overlay(e,t){let r;if(this.overlays[e]&&!t){delete this.overlays[e],r=this.overlay_renderers[e];const t=this.overlay_renderers_list.indexOf(r);return-1!==t&&this.overlay_renderers_list.splice(t,1),delete this.overlay_renderers[e],void this.mark_dirty()}if(!this.overlays[e]&&t)this.overlays[e]=t,r=new IconRenderer(this),this.overlay_renderers_list.push(r),this.overlay_renderers[e]=r,r.parent=this.main_icon_renderer;else{if(!this.overlays[e]||!t)return;r=this.overlay_renderers[e],this.overlays[e]=t}r.overlay_layer=t.overlay_layer||0;for(const e of["icon","icon_state","dir","color","alpha","offset_x","offset_y"])r[e]=t[e];this.overlay_renderers_list.sort((e,t)=>e.overlay_layer-t.overlay_layer)}get_displacement(e){let t=0,r=0;if(null!=this.screen_loc_x)t=this.screen_loc_x,r=this.screen_loc_y;else{let i=0,s=0;this.update_glide(e),this.glide&&(i=this.glide.x,s=this.glide.y),t=this.x+i,r=this.y+s}return{dispx:t,dispy:r}}get_transform(){return Matrix.identity}update_glide(e){this.glide&&this.glide.update(e)}is_mouse_over(e,t){for(const r of this.overlay_renderers_list)if(r.is_mouse_over(e,t))return!0;return this.main_icon_renderer.is_mouse_over(e,t)}on_render_tick(e){for(const t of this.overlay_renderers_list)t.on_render_tick(e);return this.main_icon_renderer.on_render_tick(e)}draw(e,t){for(const r of this.overlay_renderers_list)r.draw(e,t);let r;for(r=0;r<this.overlay_renderers_list.length;r++){const i=this.overlay_renderers_list[r];if(i.overlay_layer>=0)break;i.draw(e,t)}for(this.main_icon_renderer.draw(e,t);r<this.overlay_renderers_list.length;r++){this.overlay_renderers_list[r].draw(e,t)}}get_bounds(){let e=this.main_icon_renderer.get_bounds();for(const t of this.overlay_renderers_list){const r=t.get_bounds();r&&(e?(r.x<e.x&&(e.width+=e.x-r.x,e.x=r.x),r.y<e.y&&(e.height+=e.y-r.y,e.y=r.y),e.width=Math.max(e.width,r.x-e.x+r.width),e.height=Math.max(e.height,r.y-e.y+r.height)):e=r)}return e}get_transformed_bounds(){const e=this.get_transform(),t=this.get_bounds();if(!t)return t;const r=[[t.x,t.y],[t.x+t.width,t.y],[t.x,t.y+t.height],[t.x+t.width,t.y+t.height]];let[i,s,o,n]=[1/0,-1/0,-1/0,1/0];for(const t of r){const r=e.multiply_array([t[0]-.5,t[1]-.5]);r[0]+=.5,r[1]+=.5,i=Math.min(i,r[0]),s=Math.max(s,r[0]),o=Math.max(o,r[1]),n=Math.min(n,r[1])}return{x:i,y:n,width:s-i,height:o-n}}fully_load(e=!1){const t=[];t.push(this.main_icon_renderer.fully_load(e));for(const r of this.overlay_renderers_list)t.push(r.fully_load(e));return Promise.all(t)}get icon(){return this.main_icon_renderer.icon}set icon(e){this.main_icon_renderer.icon=e}get icon_state(){return this.main_icon_renderer.icon_state}set icon_state(e){this.main_icon_renderer.icon_state=e}get dir(){return this.main_icon_renderer.dir}set dir(e){this.main_icon_renderer.dir=e}get color(){return this.main_icon_renderer.color}set color(e){this.main_icon_renderer.color=e}get alpha(){return this.main_icon_renderer.alpha}set alpha(e){this.main_icon_renderer.alpha=e}get c(){return this.components}}class Glide{constructor(e,t){if(this.object=e,this.lasttime=t.lasttime||performance.now(),this.x=0,this.y=0,t.oldx===+t.oldx&&t.oldy===+t.oldy&&(t.oldx!==e.x||t.oldy!==e.y)&&Math.abs(Math.max(e.x-t.oldx,e.y-t.oldy))<=1.5001){let r=e.glide&&e.glide.x||0;Math.sign(r)===t.oldx-e.x&&(r=0);let i=e.glide&&e.glide.y||0;return Math.sign(i)===t.oldy-e.y&&(i=0),Object.assign(this,{x:t.oldx-e.x+r,y:t.oldy-e.y+i}),this}return e.glide}update(e){let t=this.x,r=this.y,i=+this.object.glide_size;if(i!=i&&(i=this.object.client.glide_size),i!=i||0===i)return void(this.object.glide=null);const s=Math.max(i*(e-this.lasttime)/1e3,0);this.lasttime=e,Math.abs(t)<s?t=0:t-=Math.sign(t)*s,Math.abs(r)<s?r=0:r-=Math.sign(r)*s,this.x=t,this.y=r,0===t&&0===r&&(this.object.glide=void 0)}}Atom.Glide=Glide,Atom.atom_comparator=function(e,t){if(!e&&!t)return 0;if(!e)return 1;if(!t)return-1;let r=e.layer-t.layer;return 0===r&&(r=t.y-e.y),0===r&&(e.network_id>t.network_id?r=1:e.network_id<t.network_id&&(r=-1)),r},module.exports=Atom;

},{"./icon_renderer.js":7,"./matrix.js":9,"events":36}],3:[function(require,module,exports){
"use strict";function get_audio_buffer(e,o){const r=e.audio_buffers.get(o);if(r)return r;const t=new Promise((r,t)=>{const s=new XMLHttpRequest;s.open("GET",e.resRoot+o,!0),s.responseType="arraybuffer",s.onload=(()=>{const o=s.response;r(e.audio_ctx.decodeAudioData(o))}),s.onerror=(e=>{t(e)}),s.send()});return e.audio_buffers.set(o,t),t}module.exports=get_audio_buffer;

},{}],4:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const EventEmitter=require("events");class Component extends EventEmitter{constructor(e,t){super(),t&&Object.assign(this,t),Object.defineProperty(this,"atom",{enumerable:!1,configurable:!1,writable:!1,value:e})}get a(){return this.atom}destroy(){}}module.exports=Component;

},{"events":36}],5:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Atom=require("./atom.js"),EventEmitter=require("events");class Eye extends EventEmitter{constructor(t,e){if(super(),this.client=t,this.id=e,this.planes=new Map,this.atoms=new Set,this.last_planes=new WeakMap,t.eyes[e])throw new Error(`duplicate plane of id ${e}`);t.eyes[e]=this;for(const s of t.atoms)s.eye_id===e&&(s.eye=this,this.atoms.add(s));this.mouse_over_atom=null,this.last_mouse_event=null,this.origin={x:0,y:0,glide_size:10,update_glide:Atom.prototype.update_glide,client:this.client,get_displacement:Atom.prototype.get_displacement}}draw(t){if(!this.canvas)return;const e=this.canvas.getContext("2d");e.clearRect(0,0,this.canvas.width,this.canvas.height);for(const e of this.atoms){e.on_render_tick(t);const s=this.last_planes.get(e),o=e.get_plane();s!==o&&(s&&s.atoms.delete(e),o&&o.atoms.add(e),this.last_planes.set(e,o))}for(const s of[...this.planes.values()].sort((t,e)=>t.z_index-e.z_index))s.draw(e,t);this.last_mouse_event&&this.handle_mousemove(this.last_mouse_event,t)}get_world_draw_pos(t,e,s){let{dispx:o,dispy:a}=this.origin&&this.origin.get_displacement&&this.origin.get_displacement(s)||{dispx:0,dispy:0};return[32*(t-(o=Math.round(32*o)/32)+7),32*-(e-(a=Math.round(32*a)/32)-7)]}screen_to_world(t,e,s){const{dispx:o,dispy:a}=this.origin&&this.origin.get_displacement&&this.origin.get_displacement(s)||{dispx:0,dispy:0};return[t/32-7+o,-e/32+8+a]}create_click_handlers(){this.canvas.addEventListener("mousedown",this.handle_mousedown.bind(this)),this.canvas.addEventListener("mouseover",this.handle_mouseout.bind(this)),this.canvas.addEventListener("mousemove",this.handle_mousemove.bind(this)),this.canvas.addEventListener("mouseout",this.handle_mouseout.bind(this))}get_mouse_target(t,e=performance.now()){const s=t.target.getBoundingClientRect(),o=(t.clientX-s.left)/s.width*t.target.width,a=(t.clientY-s.top)/s.height*t.target.height;let i,n,r;for(const t of[...this.planes.values()].sort((t,e)=>e.z_index-t.z_index)){if(t.no_click)continue;const[s,h]=t.calculate_origin(e),[l,c]=t.calculate_composite_offset(e),d=`[${Math.floor((o-l)/32+s)},${Math.floor((-a+t.canvas.height+c)/32+h)}]`,_=t.tiles.get(d);if(_){for(const d of[..._].sort((t,e)=>Atom.atom_comparator(e,t))){if(void 0===d.mouse_opacity&&(d.mouse_opacity=1),0===d.mouse_opacity)continue;let{dispx:_,dispy:m}=d.get_displacement(e);_=Math.round(32*_)/32,m=Math.round(32*m)/32;const[u,g]=[Math.round(32*(_-s)+l),Math.round(t.canvas.height-32*(m-h)-32+c)];i=(o-u)/32,n=1-(a-g)/32,[i,n]=d.get_transform(e).inverse().multiply_array([i-.5,n-.5]),i+=.5,n+=.5;const v=d.get_bounds(e);if(v&&i>=v.x&&i<v.x+v.width&&n>=v.y&&n<v.y+v.height&&2===d.mouse_opacity||d.is_mouse_over(i,n,e)){r=d;break}}if(r)break}}const[h,l]=this.screen_to_world(o,a,e);return{atom:r,x:i,y:n,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey,button:t.button,world_x:h,world_y:l}}handle_mousedown(t){t.preventDefault();const e=this.get_mouse_target(t),s=performance.now(),o=a=>{if(a.button!==t.button)return;document.removeEventListener("mouseup",o);const i=performance.now(),n=this.get_mouse_target(a);i-s<200||n.atom===e.atom?this.client.connection&&this.client.connection.send(JSON.stringify({click_on:Object.assign({},e,{atom:e&&e.atom&&e.atom.network_id})})):this.client.connection.send(JSON.stringify({drag:{from:Object.assign({},e,{atom:e&&e.atom&&e.atom.network_id}),to:Object.assign({},n,{atom:n&&n.atom&&n.atom.network_id})}}))};document.addEventListener("mouseup",o)}handle_mouseover(t){this.last_mouse_event=t;const e=this.get_mouse_target(t),s=this.mouse_over_atom;this.mouse_over_atom&&this.mouse_over_atom.emit("mouseout"),this.mouse_over_atom=e.atom,this.mouse_over_atom&&(this.mouse_over_atom.emit("mouseover",Object.assign(e,{original_event:t})),this.emit("mouse_over_atom_changed",s,this.mouse_over_atom))}handle_mouseout(){const t=this.mouse_over_atom;this.mouse_over_atom&&this.mouse_over_atom.emit("mouseout"),this.mouse_over_atom=null,this.last_mouse_event=null,t&&this.emit("mouse_over_atom_changed",t,null)}handle_mousemove(t,e=performance.now()){this.last_mouse_event=t;const s=this.get_mouse_target(t,e);if(s.atom!==this.mouse_over_atom){this.mouse_over_atom&&this.mouse_over_atom.emit("mouseout");const e=this.mouse_over_atom;this.mouse_over_atom=s.atom,this.mouse_over_atom&&this.mouse_over_atom.emit("mouseover",Object.assign(s,{original_event:t})),this.emit("mouse_over_atom_changed",e,this.mouse_over_atom)}else this.mouse_over_atom&&this.mouse_over_atom.emit("mousemove",Object.assign(s,{original_event:t}))}}class Plane{constructor(t,e){this.z_index=0,this.canvas=document.createElement("canvas"),this.draw_canvas=document.createElement("canvas"),this.mask_canvas=document.createElement("canvas"),this.atoms=new Set,this.dirty_atoms=new Set,this.last_draw=new Map,this.tiles=new Map,this.eye=t,this.client=t.client,this.id=e,t.planes.set(e,this)}draw(t,e){this.size_canvases(),this.draw_objects(e),this.composite_plane(t,e)}draw_objects(t){const e=this.canvas.getContext("2d"),s=this.draw_canvas.getContext("2d"),o=this.mask_canvas.getContext("2d");this.client.emit("before_draw",e,t);const[a,i]=this.calculate_origin(),n=new Set;if(null!==this.last_originx&&null!==this.last_originy){const t=a-this.last_originx,o=i-this.last_originy;0===t&&0===o||(s.clearRect(0,0,this.draw_canvas.width,this.draw_canvas.height),s.drawImage(this.canvas,32*-t,32*o),e.clearRect(0,0,this.canvas.width,this.canvas.height),e.drawImage(this.draw_canvas,0,0));const r=this.canvas.width/32,h=this.canvas.height/32;for(let t=Math.floor(a);t<Math.ceil(a+r);t++)for(let e=Math.floor(i);e<Math.ceil(i+h);e++)n.add(`[${t},${e}]`);for(let t=Math.ceil(this.last_originx);t<Math.floor(this.last_originx+r);t++)for(let e=Math.ceil(this.last_originy);e<Math.floor(this.last_originy+h);e++)n.delete(`[${t},${e}]`)}this.last_originx=a,this.last_originy=i;for(const[e,s]of this.last_draw){let o=!1;if(this.atoms.has(e)){const a=e.get_transformed_bounds(t);if(a){let{dispx:i,dispy:r}=e.get_displacement(t);if(i=Math.round(32*i)/32,r=Math.round(32*r)/32,a.x+=i,a.y+=r,a.transform=e.get_transform(t),a.x!==s.x||a.y!==s.y||a.width!==s.width||a.height!==s.height||!a.transform.equals(s.transform)){for(let t=Math.floor(s.x);t<Math.ceil(s.x+s.width);t++)for(let o=Math.floor(s.y);o<Math.ceil(s.y+s.height);o++){const s=`[${t},${o}]`,a=this.tiles.get(s);a&&a.delete(e)}for(let t=Math.floor(a.x);t<Math.ceil(a.x+a.width);t++)for(let s=Math.floor(a.y);s<Math.ceil(a.y+a.height);s++){const o=`[${t},${s}]`;let a=this.tiles.get(o);a||(a=new Set,this.tiles.set(o,a)),a.add(e),n.add(`[${t},${s}]`)}this.last_draw.set(e,a),o=!0}}else{for(let t=Math.floor(s.x);t<Math.ceil(s.x+s.width);t++)for(let o=Math.floor(s.y);o<Math.ceil(s.y+s.height);o++){const s=`[${t},${o}]`,a=this.tiles.get(s);a&&a.delete(e)}this.last_draw.delete(e),o=!0}}else{for(let t=Math.floor(s.x);t<Math.ceil(s.x+s.width);t++)for(let o=Math.floor(s.y);o<Math.ceil(s.y+s.height);o++){const s=`[${t},${o}]`,a=this.tiles.get(s);a&&a.delete(e)}this.last_draw.delete(e),o=!0}if(o)for(let t=Math.floor(s.x);t<Math.ceil(s.x+s.width);t++)for(let e=Math.floor(s.y);e<Math.ceil(s.y+s.height);e++)n.add(`[${t},${e}]`)}for(const e of this.atoms){const s=e;let o=!1;if(this.last_draw.has(s)){if(!this.dirty_atoms.has(s))continue}else o=!0;const a=s.get_transformed_bounds(t);if(!a)continue;let{dispx:i,dispy:r}=s.get_displacement(t);i=Math.round(32*i)/32,r=Math.round(32*r)/32,a.x+=i,a.y+=r,a.transform=s.get_transform(t);for(let t=Math.floor(a.x);t<Math.ceil(a.x+a.width);t++)for(let e=Math.floor(a.y);e<Math.ceil(a.y+a.height);e++){const a=`[${t},${e}]`;if(o){let t=this.tiles.get(a);t||(t=new Set,this.tiles.set(a,t)),t.add(s)}n.add(a)}this.last_draw.set(s,a)}this.dirty_atoms.clear(),s.clearRect(0,0,this.draw_canvas.width,this.draw_canvas.height),o.clearRect(0,0,this.mask_canvas.width,this.mask_canvas.height),o.fillStyle="#ffffff";for(const t of n){const e=t,[s,n]=JSON.parse(e);o.fillRect(32*(s-a),this.mask_canvas.height-32*(n-i)-32,32,32)}for(const e of[...this.atoms].sort(Atom.atom_comparator)){if(!e)continue;const o=e,r=o.get_transformed_bounds(t);if(!r)continue;let{dispx:h,dispy:l}=o.get_displacement(t);h=Math.round(32*h)/32,l=Math.round(32*l)/32,r.x+=h,r.y+=l;let c=!1;for(let t=Math.floor(r.x);t<Math.ceil(r.x+r.width);t++){for(let e=Math.floor(r.y);e<Math.ceil(r.y+r.height);e++)if(n.has(`[${t},${e}]`)){c=!0;break}if(c)break}if(!c)continue;h-=a,l-=i,s.save(),s.translate(Math.round(32*h),Math.round(this.canvas.height-32*l-32));const d=o.get_transform(t);s.translate(16,16),s.transform(d.a,-d.b,-d.c,d.d,32*d.e,32*-d.f),s.translate(-16,-16),o.draw(s,t),s.restore()}e.globalCompositeOperation="destination-out",e.drawImage(this.mask_canvas,0,0),e.globalCompositeOperation="source-over",s.globalCompositeOperation="destination-in",s.drawImage(this.mask_canvas,0,0),s.globalCompositeOperation="source-over",e.drawImage(this.draw_canvas,0,0),this.client.emit("after_draw",e,t)}calculate_origin(){return[0,0]}calculate_composite_offset(t){return[0,0]}composite_plane(t,e){const[s,o]=this.calculate_composite_offset(e);t.drawImage(this.canvas,s,o)}calculate_canvas_size(){return[this.eye.canvas.width,this.eye.canvas.height]}size_canvases(){const[t,e]=this.calculate_canvas_size();return(t!==this.canvas.width||e!==this.canvas.height)&&(this.canvas.width=t,this.canvas.height=e,this.draw_canvas.width=t,this.draw_canvas.height=e,this.mask_canvas.width=t,this.mask_canvas.height=e,!0)}}class WorldPlane extends Plane{constructor(t,e){super(t,e)}calculate_canvas_size(){return[32*Math.ceil(this.eye.canvas.width/32+2),32*Math.ceil(this.eye.canvas.height/32+2)]}calculate_origin(){const[t,e]=[Math.round(this.eye.origin.x),Math.round(this.eye.origin.y)];return[t-Math.floor((this.canvas.width/32-1)/2),e-Math.floor((this.canvas.height/32-1)/2)]}calculate_composite_offset(t){const[e,s]=this.calculate_origin();let{dispx:o,dispy:a}=this.eye.origin&&this.eye.origin.get_displacement?this.eye.origin.get_displacement(t):{dispx:0,dispy:0};return[32*e-32*(o=Math.round(32*o)/32)+224,32*-s+32*(a=Math.round(32*a)/32)-288]}}class LightingPlane extends WorldPlane{constructor(t,e){super(t,e),this.no_click=!0}composite_plane(t,e){const s=this.draw_canvas.getContext("2d"),o=this.canvas.getContext("2d");o.globalCompositeOperation="destination-over",o.fillStyle="#000000",o.fillRect(0,0,this.canvas.width,this.canvas.height),o.globalCompositeOperation="source-over",s.clearRect(0,0,this.draw_canvas.width,this.draw_canvas.height),s.globalCompositeOperation="copy",s.drawImage(t.canvas,0,0),s.globalCompositeOperation="source-over",t.globalCompositeOperation="multiply",super.composite_plane(t,e),t.globalCompositeOperation="destination-in",t.drawImage(this.draw_canvas,0,0),t.globalCompositeOperation="source-over"}}Plane.World=WorldPlane,Plane.Lighting=LightingPlane,module.exports={Eye:Eye,Plane:Plane};

},{"./atom.js":2,"events":36}],6:[function(require,module,exports){
"use strict";function enqueue_icon_meta_load(e,_){if(_||(_="icons/error.png",console.info("MISSING ICON: Icon not defined!")),e.icon_meta_load_queue[_])return e.icon_meta_load_queue[_];const t=new Promise((t,a)=>{const o={width:32,height:32};o.__image_object=new Image;const i=e.resRoot+_;o.__image_object.src=i,o.__image_object.addEventListener("load",()=>{o.__image_object.canvas=document.createElement("canvas"),o.__image_object.ctx=o.__image_object.canvas.getContext("2d"),o.__image_object.canvas.width=o.__image_object.width,o.__image_object.canvas.height=o.__image_object.height,o.__image_object.ctx.drawImage(o.__image_object,0,0),o.__image_data=o.__image_object.ctx.getImageData(0,0,o.width,o.height),o.height=o.__image_object.height,o.animated_nr=Math.round(o.__image_object.width/o.__image_object.height),o.width=o.height,o.animated=o.animated_nr>1?1:0,t(),e.icon_meta_load_queue[_]=void 0}),o.__image_object.addEventListener("error",e=>{a(e||new Error(`Loading failed for ${_}`))}),e.icon_metas[_]=o});return e.icon_meta_load_queue[_]=t,t}module.exports=enqueue_icon_meta_load;

},{}],7:[function(require,module,exports){
"use strict";const CHANGE_LEVEL_NONE=0,CHANGE_LEVEL_DIR=1,CHANGE_LEVEL_ICON_STATE=2,CHANGE_LEVEL_ICON=3,color_canvas=document.createElement("canvas");class IconRenderer{constructor(t){t.client?this.client=t.client:this.client=t,this.atom=t,this._overlay_layer=0,this.change_level=0,this._offset_x=0,this._offset_y=0,this.icon_frame=0,this.genicon="",this.dir||(this.dir=1)}fully_load(t=!1){return this.icon_meta||!this.genicon?Promise.resolve():(this.icon&&-1!==this.icon.search(".png")?this.genicon=this.icon:this.icon&&this.icon_state&&-1===this.icon.search(".png")&&(!0===this.atom.directional||!0===t||-1!==this.icon.search("icons/mob/")&&-1===this.icon.search("icons/mob/under/")?this.genicon=`${this.icon}${this.icon_state}/${this.icon_state}-dir${this.dir}.png`:this.genicon=`${this.icon}${this.icon_state}.png`),this.client.enqueue_icon_meta_load(this.client,this.genicon))}get_bounds(){if(!this.icon_meta)return;const t=this.get_offset();return{x:t[0],y:1-this.icon_meta.height/32+t[1],width:this.icon_meta.width/32,height:this.icon_meta.height/32}}check_levels(){this.icon!==this.last_icon?this.change_level=Math.max(this.change_level,CHANGE_LEVEL_ICON):this.icon_state!==this.last_icon_state?this.change_level=Math.max(this.change_level,CHANGE_LEVEL_ICON_STATE):this.dir!==this.last_dir&&(this.change_level=Math.max(this.change_level,CHANGE_LEVEL_DIR),this.last_dir=this.dir)}on_render_tick(){if(this.check_levels(),this.change_level>=CHANGE_LEVEL_NONE&&this.atom&&this.atom.mark_dirty(),this.change_level>=CHANGE_LEVEL_DIR&&(this.icon&&-1!==this.icon.search(".png")&&(this.genicon=this.icon),this.icon_meta=null,this.atom.client.icon_metas[this.genicon]&&(this.icon_meta=this.atom.client.icon_metas[this.genicon]),null===this.icon_meta||""===this.genicon||this.icon!==this.last_icon||this.icon_state!==this.last_icon_state)){this.change_level=CHANGE_LEVEL_NONE;const t=this.genicon;if(!1===this.get_directional())return;return this.genicon||(this.genicon="icons/nothing.png"),this.last_icon_state=this.icon_state,this.last_icon=this.icon,this.atom.client.enqueue_icon_meta_load(this.atom.client,this.genicon).then(()=>{this.atom.client.icon_metas[this.genicon]&&(this.icon_meta=this.atom.client.icon_metas[this.genicon]),this.genicon===t&&(this.change_level=CHANGE_LEVEL_ICON)}).catch(t=>{console.error(t)}),void(this.change_level=CHANGE_LEVEL_NONE)}this.change_level=CHANGE_LEVEL_NONE}draw(t){if(!this.icon_meta||!this.icon_meta.__image_object)return;let i=this.icon_meta.__image_object,e=null,s=0;if(this.color?e=this.color:this.icon_meta.color&&(e=this.icon_meta.color),this.icon_meta.animated&&(s=this.icon_meta.__image_object.height*Math.floor(this.icon_frame),this.icon_frame+=.1,this.icon_frame>=this.icon_meta.animated_nr&&(this.icon_frame=0)),e){color_canvas.width=Math.max(color_canvas.width,this.icon_meta.width),color_canvas.height=Math.max(color_canvas.height,this.icon_meta.height);const t=color_canvas.getContext("2d");t.clearRect(0,0,this.icon_meta.width+1,this.icon_meta.height+1),t.fillStyle=this.color,t.globalCompositeOperation="source-over",t.drawImage(i,s,0,this.icon_meta.width,this.icon_meta.height,0,0,this.icon_meta.width,this.icon_meta.height),t.globalCompositeOperation="multiply",t.fillRect(0,0,this.icon_meta.width,this.icon_meta.height),t.globalCompositeOperation="destination-in",t.drawImage(i,s,0,this.icon_meta.width,this.icon_meta.height,0,0,this.icon_meta.width,this.icon_meta.height),t.globalCompositeOperation="source-over",i=color_canvas}const h=this.get_offset();t.drawImage(i,s,0,this.icon_meta.width,this.icon_meta.height,Math.round(32*h[0]),Math.round(32*-h[1]),this.icon_meta.width,this.icon_meta.height)}get_directional(){if(this.icon&&this.icon_state&&-1===this.icon.search(".png"))!0===this.atom.directional||-1!==this.icon.search("icons/mob/")&&-1===this.icon.search("icons/mob/under/")?this.genicon=`${this.icon}${this.icon_state}/${this.icon_state}-dir${this.dir}.png`:this.genicon=`${this.icon}${this.icon_state}.png`;else if(""===this.icon_state&&""===this.icon)return!1;return!0}is_mouse_over(t,i){if(!this.icon_meta||!this.icon_meta.__image_data)return!1;const e=this.get_offset();t-=e[0],i-=e[1];const s=Math.floor(32*t),h=Math.floor(32-32*i);if(s<0||h<0||s>this.icon_meta.width||h>this.icon_meta.height)return!1;const o=3+4*(s+h*this.icon_meta.__image_data.width);return this.icon_meta.__image_data.data[o]>0}get icon(){return null===this._icon&&this.parent?this.parent.icon:this._icon}set icon(t){this._icon=t}get icon_state(){if(null===this._icon_state&&this.parent)return this.parent.icon_state;let t=this._icon_state;return this.parent&&(t=(""+t).replace(/\[parent\]/g,this.parent.icon_state)),t}set icon_state(t){this._icon_state=t}get dir(){return null===this._dir&&this.parent?this.parent.dir:this._dir}set dir(t){this._dir=t}get overlay_layer(){return this._overlay_layer}set overlay_layer(t){t!==this._overlay_layer&&(this._overlay_layer=t,this.atom&&this.atom.mark_dirty())}get offset_x(){return this._offset_x}set offset_x(t){t!==this._offset_x&&(this._offset_x=+t||0,this.atom&&this.atom.mark_dirty())}get offset_y(){return this._offset_y}set offset_y(t){t!==this._offset_y&&(this._offset_y=+t||0,this.atom&&this.atom.mark_dirty())}get_offset(){let t=this.offset_x,i=this.offset_y;if(this.icon_meta&&this.icon_meta.directional_offset){const e=this.icon_meta.directional_offset/32;1&this.dir&&(i+=e),2&this.dir&&(i-=e),4&this.dir&&(t+=e),8&this.dir&&(t-=e)}return[t,i]}get color(){return null===this._color&&this.parent?this.parent.color:this._color}set color(t){t!==this._color&&(this._color=""+t,this.atom&&this.atom.mark_dirty())}get alpha(){return this._alpha}set alpha(t){t!==this._alpha&&(this._alpha=""+t,this.atom&&this.atom.mark_dirty())}}module.exports=IconRenderer;

},{}],8:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{Component:Component}=require("../index.js");class LightingObject extends Component{constructor(t,s){super(t,s),this.atom.draw=this.draw.bind(this),this.atom.get_bounds=this.get_bounds.bind(this),this.atom.on_render_tick=this.on_render_tick.bind(this),this.atom.is_mouse_over=(()=>!1),this.atom.get_plane_id=(()=>"lighting"),this.canvas=document.createElement("canvas"),this.random_angle_offset=Math.random(),this.soft_shadow_radius=1/8}on_render_tick(t){const s=this.a.get_displacement(t);this.color!==this.last_color?this.dirty=!0:this.radius!==this.last_radius?this.dirty=!0:this.shadows_list!==this.last_shadows_list?this.dirty=!0:this.last_disp&&this.last_disp.dispx===s.dispx&&this.last_disp.dispy===s.dispy?this.a.client.soft_shadow_resolution!==this.last_resolution&&(this.random_angle_offset=Math.random(),this.dirty=!0):this.dirty=!0,this.dirty&&this.a.mark_dirty(),this.last_color=this.color,this.last_radius=this.radius,this.last_shadows_list=this.shadows_list,this.last_disp=s}get_bounds(){return{x:-this.radius,y:-this.radius,width:2*this.radius+1,height:2*this.radius+1}}draw(t,s){if(null==this.atom.screen_loc_x&&this.radius===+this.radius&&this.enabled){if(this.dirty){this.last_resolution=this.a.client.soft_shadow_resolution,this.canvas.width=32+64*this.radius,this.canvas.height=32+64*this.radius;const t=this.canvas.getContext("2d");t.fillStyle="black",t.fillRect(0,0,t.width,t.height);const i=.5*this.canvas.width;let{dispx:h,dispy:a}=this.atom.get_displacement(s);if(h=Math.round(32*h)/32,a=Math.round(32*a)/32,h!==+h||a!==+a)return;const e=[];if(this.soft_shadow_radius<=0||this.a.client.soft_shadow_resolution<=1)e.push([h,a]);else for(let t=0;t<this.a.client.soft_shadow_resolution;t++){const s=(t+this.random_angle_offset)*Math.PI*2/this.a.client.soft_shadow_resolution;e.push([h+Math.cos(s)*this.soft_shadow_radius,a+Math.sin(s)*this.soft_shadow_radius])}t.fillStyle="black",t.fillRect(0,0,this.canvas.width,this.canvas.height);const o=Math.ceil(255/e.length);t.fillStyle=`rgb(${o},${o},${o})`,t.globalCompositeOperation="lighter";for(let s=0;s<e.length;s++){const[o,l]=e[s],n=i+Math.round(32*(o-h)),d=i-Math.round(32*(l-a)),r=Math.round(-16-32*o),u=Math.round(16+32*l),_=[];for(const t of this.shadows_list){const s={};if(s.x1=32*t.x1+r,s.y1=32*-t.y2+u,s.x2=32*t.x2+r,s.y2=32*-t.y1+u,s.base_width=s.x2-s.x1,s.base_height=s.y2-s.y1,s.used_horizontally=!1,s.used_vertically=!1,s.x1<0&&s.y1<0&&s.x2>0&&s.y2>0)continue;let i=Math.min(Math.abs(s.x1),Math.abs(s.x2)),h=Math.min(Math.abs(s.y1),Math.abs(s.y2));s.x1<=0&&s.x2>=0&&(i=0),s.y1<=0&&s.y2>=0&&(h=0),s.dist=i+h,_.push(s)}_.sort((t,s)=>t.dist-s.dist);for(let t=0;t<_.length;t++){const s=_[t];if(!s.used_horizontally&&!s.used_vertically)for(let i=t+1;i<_.length;i++){const t=_[i];if((!t.used_vertically||!t.used_horizontally)&&(s.x1>0&&s.x1===t.x1&&(s.y1===t.y2||s.y2===t.y1)||s.y1>0&&s.y1===t.y1&&(s.x1===t.x2||s.x2===t.x1)||s.x2<0&&s.x2===t.x2&&(s.y1===t.y2||s.y2===t.y1)||s.y2<0&&s.y2===t.y2&&(s.x1===t.x2||s.x2===t.x1))){if(s.x1===t.x1||s.x2===t.x2){if(t.used_vertically)continue;t.used_vertically=!0}if(s.y1===t.y1||s.y2===t.y2){if(t.used_horizontally)continue;t.used_horizontally=!0}s.x1=Math.min(s.x1,t.x1),s.y1=Math.min(s.y1,t.y1),s.x2=Math.max(s.x2,t.x2),s.y2=Math.max(s.y2,t.y2)}}}t.beginPath();for(const s of _){if(s.used_horizontally||s.used_vertically)continue;let i=1,h=1,a=!1,e=s.x1,o=s.y1,l=s.x2,r=s.y2;const u=[];if(s.x2<0&&(i=-1,[e,l]=[-l,-e]),s.y2<0&&(h=-1,[o,r]=[-r,-o]),e<=0&&l>=0){a=i!==h,u.push([n+e*i,d+(o+s.base_height)*h]),u.push([n+e*i,d+o*h]);let t=(32*this.radius+48)/o;u.push([n+e*i*t,d+o*h*t]),t=(32*this.radius+48)/o,u.push([n+l*i*t,d+o*h*t]),u.push([n+l*i,d+o*h]),u.push([n+l*i,d+(o+s.base_height)*h])}else if(o<=0&&r>=0){a=i===h,u.push([n+(e+s.base_width)*i,d+o*h]),u.push([n+e*i,d+o*h]);let t=(32*this.radius+48)/e;u.push([n+e*i*t,d+o*h*t]),t=(32*this.radius+48)/e,u.push([n+e*i*t,d+r*h*t]),u.push([n+e*i,d+r*h]),u.push([n+(e+s.base_width)*i,d+r*h])}else{a=i!=h,u.push([n+(e+s.base_width)*i,d+(o+s.base_height)*h]),u.push([n+(e+s.base_width)*i,d+r*h]),u.push([n+e*i,d+r*h]);let t=(32*this.radius+48)/Math.max(e,r);u.push([n+e*i*t,d+r*h*t]),u.push([n+(32*this.radius+48)*i,d+(32*this.radius+48)*h]),t=(32*this.radius+48)/Math.max(l,o),u.push([n+l*i*t,d+o*h*t]),u.push([n+l*i,d+o*h]),u.push([n+l*i,d+(o+s.base_height)*h])}if(a)for(let s=u.length-1;s>=0;s--)s===u.length-1?t.moveTo(u[s][0],u[s][1]):t.lineTo(u[s][0],u[s][1]);else for(let s=0;s<u.length;s++)0===s?t.moveTo(u[s][0],u[s][1]):t.lineTo(u[s][0],u[s][1]);t.closePath()}t.fill()}t.fillStyle="white",t.globalCompositeOperation="difference",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.globalCompositeOperation="multiply";const l=t.createRadialGradient(i,i,0,i,i,i);l.addColorStop(0,this.color),l.addColorStop(1,"black"),t.fillStyle=l,t.fillRect(0,0,this.canvas.width,this.canvas.height),t.globalCompositeOperation="source-over",this.dirty=!1}t.globalCompositeOperation="lighter",t.drawImage(this.canvas,32*-this.radius,32*-this.radius),t.globalCompositeOperation="source-over"}}}module.exports.components={LightingObject:LightingObject};

},{"../index.js":1}],9:[function(require,module,exports){
"use strict";class Matrix{constructor(t,i,s,e,r,a){this.a=t,this.b=i,this.c=s,this.d=e,this.e=r,this.f=a,Object.freeze(this)}multiply(t){const i=this.a,s=this.b,e=this.c,r=this.d,a=this.e,h=this.f,n=t.a,c=t.b,l=t.c,u=t.d,o=t.e,M=t.f;return new Matrix(i*n+c*e,n*s+c*r,i*l+e*u,s*l+r*u,a+i*o+e*M,s*o+h+r*M)}multiply_array(t){const i=this.a,s=this.b,e=this.c,r=this.d,a=this.e,h=this.f;if(t instanceof Array)return[t[0]*i+t[1]*e+a,t[0]*s+t[1]*r+h]}inverse(){const t=this.a,i=this.b,s=this.c,e=this.d,r=this.e,a=this.f;return new Matrix(e/(t*e-i*s),i/(i*s-t*e),s/(i*s-t*e),t/(t*e-i*s),(e*r-s*a)/(i*s-t*e),(i*r-t*a)/(t*e-i*s))}translate(t=0,i=0){return this.multiply(new Matrix(1,0,0,1,t,i))}rotate(t,i=0,s=0){const e=Math.cos(t),r=Math.sin(t);return this.translate(-i,-s).multiply(new Matrix(e,r,-r,e,0,0)).translate(i,s)}scale(t,i,s=0,e=0){return void 0===i&&(i=t),this.translate(-s,-e).multiply(new Matrix(t,0,0,i,0,0)).translate(s,e)}equals(t){return t.a===this.a&&t.b===this.b&&t.c===this.c&&t.d===this.d&&t.e===this.e&&t.f===this.f}}Matrix.identity=new Matrix(1,0,0,1,0,0),module.exports=Matrix;

},{}],10:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const Panel=require("./panel.js"),EventEmitter=require("events");class PanelManager extends EventEmitter{constructor(e){super(),this.client=e,this.panels={}}send_message(e){this.client.connection&&this.client.connection.send(JSON.stringify({panel:e}))}create_client_panel(e){const t=new Panel(this,null,e);return this.emit("create",t,e),t}handle_message(e){if(e.create)for(const t in e.create){if(!Object.prototype.hasOwnProperty.call(e.create,t))continue;this.panels[t]&&console.warn(`The server tried to open a panel with the same ID ${t} twice! ${JSON.stringify(e.create[t])}`);const n=new Panel(this,t,e.create[t]);this.emit("create",n,e.create[t])}if(e.message)for(const t of e.message){const e=this.panels[t.id];e&&e.emit("message",t.contents)}if(e.close)for(const t of e.close){const e=this.panels[t];e&&e.close()}}}module.exports=PanelManager;

},{"./panel.js":11,"events":36}],11:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const EventEmitter=require("events");class Panel extends EventEmitter{constructor(t,e,{width:n=400,height:s=400,title:i="",can_close:o=!0,content_class:a=""}={}){super();const r=document.documentElement.clientWidth/2-n/2,d=document.documentElement.clientHeight/2-s/2;if(this.container_obj=document.createElement("div"),Object.assign(this.container_obj.style,{width:n+"px",height:s+"px",left:r+"px",top:d+"px"}),this.container_obj.classList.add("uiframe-container"),this.panel_obj=document.createElement("div"),this.panel_obj.classList.add("uiframe"),this.panel_obj.tabIndex=-1,this.header_obj=document.createElement("div"),this.header_obj.classList.add("uiframe-header"),this.title_node=document.createTextNode(i),this.header_obj.appendChild(this.title_node),this.content_obj=document.createElement("div"),this.content_obj.classList.add("uiframe-content"),this.panel_obj.appendChild(this.header_obj),this.panel_obj.appendChild(this.content_obj),this.container_obj.appendChild(this.panel_obj),document.getElementById("uiframes-container").appendChild(this.container_obj),this.header_obj.addEventListener("mousedown",this._start_drag.bind(this)),this.container_obj.addEventListener("mousedown",this._start_resize.bind(this)),this.container_obj.addEventListener("mousemove",this._container_mousemove.bind(this)),this.container_obj.addEventListener("mouseout",this._container_mouseout.bind(this)),this.content_obj.addEventListener("click",this.click.bind(this)),this.can_close=o,this.manager=t,t.panels[e]=this,this.id=e,o&&(this.close_button=document.createElement("div"),this.close_button.classList.add("uiframe-close-button"),this.header_obj.appendChild(this.close_button),this.close_button.addEventListener("click",()=>{this.close()}),this.close_button.addEventListener("mousedown",t=>{t.preventDefault()})),a){const e=t.client.panel_classes[a];e?this.content_controller=new e(this,this.manager):console.warn(`${a} is a nonexistent panel class`)}}_start_drag(t){if(t.defaultPrevented)return;if(t.target!==this.header_obj)return;const e=(this.container_obj.offsetWidth-this.panel_obj.offsetWidth)/2;t.preventDefault(),this.panel_obj.focus();let n=t.clientX,s=t.clientY;this.mouseup(t=>{const i=t.clientX-n,o=t.clientY-s;n=t.clientX,s=t.clientY;const{left:a,top:r}=this.container_obj.getBoundingClientRect();this.container_obj.style.left=Math.min(document.documentElement.clientWidth-160-e,Math.max(-e,a+i))+"px",this.container_obj.style.top=Math.min(document.documentElement.clientHeight-35-e,Math.max(-e,r+o))+"px",this.emit("move")})}_resize_meta(t){const e={drag_right:!1,drag_left:!1,drag_up:!1,drag_down:!1,cursor:"default",can_resize:!1};return this.e_target_in_container(t,e),e.can_resize=e.drag_right||e.drag_left||e.drag_up||e.drag_down,e}e_target_in_container(t,e){const n=(this.container_obj.offsetWidth-this.panel_obj.offsetWidth)/2,s=this.panel_obj.offsetWidth,i=this.panel_obj.offsetHeight;t.target===this.container_obj&&(t.offsetX<n&&(e.drag_left=!0),t.offsetY<n&&(e.drag_up=!0),t.offsetX>s+n&&(e.drag_right=!0),t.offsetY>i+n&&(e.drag_down=!0),e.drag_left&&e.drag_down||e.drag_up&&e.drag_right?e.cursor="nesw-resize":e.drag_left&&e.drag_up||e.drag_down&&e.drag_right?e.cursor="nwse-resize":e.drag_left||e.drag_right?e.cursor="ew-resize":(e.drag_up||e.drag_down)&&(e.cursor="ns-resize"))}_start_resize(t){this.container_obj!==document.getElementById("uiframes-container").lastChild&&document.getElementById("uiframes-container").appendChild(this.container_obj);const e=this._resize_meta(t);if(!e.can_resize)return;const n=(this.container_obj.offsetWidth-this.panel_obj.offsetWidth)/2;t.preventDefault(),this.panel_obj.focus();let s=t.clientX,i=t.clientY;this.mouseup(t=>{const o=t.clientX-s,a=t.clientY-i;s=t.clientX,i=t.clientY;const{left:r,top:d}=this.container_obj.getBoundingClientRect();e.drag_left?(this.container_obj.style.left=Math.min(document.documentElement.clientWidth-160-n,Math.max(-n,r+o))+"px",this.container_obj.style.width=Math.max(160,this.panel_obj.clientWidth-o)+"px"):e.drag_right&&(this.container_obj.style.width=Math.max(160,this.panel_obj.clientWidth+o)+"px"),e.drag_up?(this.container_obj.style.top=Math.min(document.documentElement.clientHeight-35-n,Math.max(-n,d+a))+"px",this.container_obj.style.height=Math.max(35,this.panel_obj.clientHeight-a)+"px"):e.drag_down&&(this.container_obj.style.height=Math.max(35,this.panel_obj.clientHeight+a)+"px"),this.emit("resize")})}mouseup(t){const e=()=>{document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",e)};document.addEventListener("mousemove",t),document.addEventListener("mouseup",e)}_container_mousemove(t){const e=this._resize_meta(t);this.container_obj.style.cursor=e.cursor}_container_mouseout(){this.container_obj.style.cursor="default"}get title(){return this.title_node.textContent}set title(t){this.title_node.textContent=t}send_message(t){if(!this.id)throw new Error("Cannot send a panel message without an ID!");this.manager.send_message({message:[{id:this.id,contents:t}]})}close(){this.id&&(this.manager.send_message({close:[this.id]}),this.manager.panels[this.id]===this&&(this.manager.panels[this.id]=null)),document.getElementById("uiframes-container").removeChild(this.container_obj),this.emit("close")}click(t){const e=t.target.closest(".button");if(this.is_valid_button(e)){if(e.dataset.message&&this.send_message(JSON.parse(e.dataset.message)),e.dataset.radioGroup){for(const t of this.content_obj.querySelectorAll(`.button.selected[data-radio-group='${e.dataset.radioGroup}']`))t.classList.remove("selected");e.classList.add("selected"),e.dataset.radioValue&&this.send_message({[e.dataset.radioGroup]:e.dataset.radioValue})}if(e.dataset.toggle){e.classList.toggle("on");const t=e.classList.contains("on");"1"!==e.dataset.toggle&&"true"!==e.dataset.toggle&&this.send_message(build_message(e.dataset.toggle,t))}}}is_valid_button(t){return t&&t.classList&&t.classList.contains("button")&&!t.classList.contains("disabled")&&!t.classList.contains("selected")}$(t){return this.content_obj.querySelector(t)}$$(t){return this.content_obj.querySelectorAll(t)}}function build_message(t,e){let n;const s=n,i=t.split(/./g);for(let t=0;t<i.length-1;t++)n[i[t]]=n={};return n[i[i.length-1]]=e,s}module.exports=Panel;

},{"events":36}],12:[function(require,module,exports){
"use strict";function anim_loop(i){for(const o of Object.values(this.eyes))if(o){o.draw(i)}if(this.audio_ctx)for(const o of this.playing_sounds.values())o.update_spatial(o.emitter,i);requestAnimationFrame(anim_loop.bind(this))}module.exports=anim_loop;

},{}],13:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class Sound{emit_from(){throw new Error("Method not implemented.")}constructor(t,e){this.client=t,"string"==typeof e.emitter&&(e.emitter=this.client.atoms_by_netid[e.emitter]),this.emitter=e.emitter,this.id=e.id||"id"+Math.random(),this.client.playing_sounds.set(this.id,this),this.buffer_promise=this.client.get_audio_buffer(t,e.path),this.client.audio_ctx&&(this.source=this.client.audio_ctx.createBufferSource(),e.detune&&(this.source.detune.value=e.detune),e.playback_rate&&(this.source.playbackRate.value=e.playback_rate),e.loop&&(this.source.loop=!0),this.apply_effects(e,this.source).connect(this.client.audio_ctx.destination))}apply_effects(t,e){return t.volume&&(e=this.apply_volume(t.volume,e)),t.emitter&&(e=this.apply_spatial(t.emitter,e)),e}apply_volume(t,e){const i=this.client.audio_ctx.createGain();return i.gain.value=t,e.connect(i),i}apply_spatial(t,e){return this.spatial_node=this.client.audio_ctx.createPanner(),this.spatial_node.panningModel="HRTF",e.connect(this.spatial_node),this.update_spatial(t,performance.now()),this.spatial_node}update_spatial(t,e){if(this.spatial_node){const i=t.eye||this.client.eyes[t.eye_id||""];if(!i)return;const s=i.origin.get_displacement(e);if(s.dispx!==+s.dispx||s.dispy!==+s.dispy)return;if(t.x!==+t.x||t.y!==+t.y)return;this.spatial_node.setPosition(t.x-s.dispx,0,-t.y+s.dispy)}}start(){this.client.audio_ctx&&this.buffer_promise.then(t=>{this.source&&(this.source.buffer=t,this.source.addEventListener("ended",this.ended.bind(this)),this.source.start(),this.stop=(()=>{this.source.stop(),this.source=null}))})}stop(){this.ended(),this.source=null}ended(){this.client.playing_sounds.delete(this.id)}}module.exports=Sound;

},{}],14:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{Component:Component}=require("../client/index.js");class Tooltip extends Component{constructor(e,t){super(e,t),this.a.on("mouseover",this.mouseover.bind(this)),this.a.on("mouseout",this.mouseout.bind(this)),this.a.on("mousemove",this.mousemove.bind(this)),this.alert_div=document.createElement("div"),this.alert_div.classList.add("tooltip"),this.alert_div.classList.add(this.theme||"midnight"),this.alert_div.innerHTML='<div class="content"><h1 class="title"></h1><p class="desc"></p></div>',this.title_elem=this.alert_div.querySelector(".title"),this.desc_elem=this.alert_div.querySelector(".desc")}mouseover(e){this.title_elem.textContent=this.a.name,this.desc_elem.textContent=this.desc;const t=document.createElement("div");t.classList.add("dropdown","tooltip-wrapper"),t.appendChild(this.alert_div),document.body.appendChild(t),this.mousemove(e)}mouseout(){this.alert_div.parentNode&&this.alert_div.parentNode.parentNode&&this.alert_div.parentNode.parentNode.removeChild(this.alert_div.parentNode),this.alert_div.parentNode&&this.alert_div.parentNode.removeChild(this.alert_div)}mousemove(e){this.alert_div.parentNode&&(this.alert_div.parentNode.style.left=e.original_event.clientX+"px",this.alert_div.parentNode.style.top=e.original_event.clientY+"px")}}module.exports.components={Tooltip:Tooltip};

},{"../client/index.js":1}],15:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{Component:Component,chain_func:chain_func}=require("../client/index.js");class CarbonMob extends Component{constructor(t,i){super(t,i),this.a.get_transform=chain_func(this.a.get_transform,this.get_transform.bind(this)),this.last_timestamp=0,this.lying_direction=-1,this.interpolated_lying=this.lying?1:0,this.last_jitter=-1/0,this.last_jitter_x=0,this.last_jitter_y=0}get_transform(t,i){let s=t();const n=i-this.last_timestamp;n>0&&(this.lying?(0===this.interpolated_lying&&(this.lying_direction=Math.random()<.5?1:-1),this.interpolated_lying=Math.min(this.interpolated_lying+n/150,1)):this.interpolated_lying=Math.max(this.interpolated_lying-n/150,0),this.last_timestamp=i),s=s.translate(0,.1875*-this.interpolated_lying).rotate(this.lying_direction*this.interpolated_lying*Math.PI*.5);const e=i-this.last_jitter;if(e<2400){const t=Math.abs(((e/200-1)%2+2)%2-1);s=s.translate(Math.round(this.last_jitter_x*t*32)/32,Math.round(this.last_jitter_y*t*32)/32)}if(this.jitteriness&&e>=2e3){const t=Math.min(4,this.jitteriness/100+1)/32;this.last_jitter_x=(Math.random()-.5)*t*2,this.last_jitter_y=(Math.random()-.5)*t*6,this.last_jitter=i}return s}}module.exports.components={CarbonMob:CarbonMob};

},{"../client/index.js":1}],16:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{Component:Component,chain_func:chain_func}=require("../client/index.js");class GridDisplay extends Component{constructor(t,s){super(t,s),this.a.get_bounds=chain_func(this.a.get_bounds,this.get_bounds.bind(this)),this.a.draw=chain_func(this.a.draw,this.draw.bind(this)),this.a.is_mouse_over=chain_func(this.a.is_mouse_over,this.is_mouse_over.bind(this))}get_bounds(t){const s=t();return s?(s.width+=(this.width-1)*this.offset_x*32,s.height+=(this.height-1)*this.offset_y*32,s):s}draw(t,s){for(let i=0;i<this.width;i++)for(let e=0;e<this.height;e++)s.save(),s.translate(i*this.offset_x*32,-e*this.offset_y*32),t(),s.restore()}is_mouse_over(t,s,i){for(let e=0;e<this.width;e++)for(let h=0;h<this.height;h++)if(t(s-e,i-h))return!0;return!1}}module.exports.components={GridDisplay:GridDisplay};

},{"../client/index.js":1}],17:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{Atom:Atom,chain_func:chain_func,Plane:Plane}=require("../client/index.js");module.exports.ParallaxPlane=class extends Plane{constructor(e,t){super(e,t),this.no_click=!0,this.parallax_velocity=[0,0],this.parallax_offset=[0,0],this.parallax_velocity_lasttimestamp=-1;for(let t=0;t<2;t++)for(let a=0;a<2;a++)for(let i=1;i<=2;i++){const s=new Atom(this.client,{icon:"icons/effects/",icon_state:"parallax",layer:-10+i,eye_id:e.id});s.get_plane_id=(()=>"parallax"),s.get_displacement=function(e){const s=this.eye&&this.eye.origin&&this.eye.origin.get_displacement&&this.eye.origin.get_displacement(e);let l=0,o=0;return s&&(l=-(s.dispx+this.get_plane().parallax_offset[0])*i,o=-(s.dispy+this.get_plane().parallax_offset[1])*i),l=(l%480-480)%480,o=(o%480+480)%480,l+=480*t,o+=480*a,{dispx:l/=32,dispy:o/=32}},s.draw=chain_func(s.draw,function(e,t){t.globalCompositeOperation="lighten",e(),t.globalCompositeOperation="source-over"})}}draw_objects(e){if(-1!==this.parallax_velocity_lasttimestamp){const t=(e-this.parallax_velocity_lasttimestamp)/1e3;this.parallax_offset[0]+=this.parallax_velocity[0]*t,this.parallax_offset[1]+=this.parallax_velocity[1]*t}this.parallax_velocity_lasttimestamp=e,super.draw_objects(e)}composite_plane(e,t){const a=this.mask_canvas.getContext("2d");a.clearRect(0,0,e.canvas.width,e.canvas.height),a.fillStyle="#ffffff";const{dispx:i,dispy:s}=this.eye.origin&&this.eye.origin.get_displacement&&this.eye.origin.get_displacement(t)||{dispx:0,dispy:0};for(const e of this.client.visible_tiles){const[t,l]=JSON.parse(e);a.fillRect(Math.round(32*(t-i+7)),Math.round(32*-(l-s-7)),32,32)}a.globalCompositeOperation="source-in",super.composite_plane(a,t),a.globalCompositeOperation="source-over",e.globalCompositeOperation="destination-over",e.drawImage(this.mask_canvas,0,0),e.globalCompositeOperation="source-over"}};

},{"../client/index.js":1}],18:[function(require,module,exports){
"use strict";const preload_list=["icons/error.png"];module.exports=async function(o){for(const e of preload_list)o.icon_metas[e]||await o.enqueue_icon_meta_load(o,e)};

},{}],19:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{chain_func:chain_func,Component:Component}=require("../client/index.js"),PROGRESSBAR_HEIGHT=6/32,_progress_bars=Symbol("_progress_bars");class ProgressBar extends Component{constructor(t,s){super(t,s),t.get_displacement=this.get_displacement.bind(this),t.get_plane_id=this.get_plane_id.bind(this),t.on_render_tick=chain_func(t.on_render_tick,this.on_render_tick.bind(this))}update_offset(t){if(this.target_offset_y&&this.target_offset_y<this.offset_y&&this.last_timestamp&&(this.offset_y=Math.max(this.target_offset_y,this.offset_y-(t-this.last_timestamp)/640)),!this.attached_atom){if(this.attached_atom=this.atom.client.atoms_by_netid[this.attached_atom_id],this.attached_atom[_progress_bars]||(this.attached_atom[_progress_bars]=[]),this.target_offset_y=1+PROGRESSBAR_HEIGHT*this.attached_atom[_progress_bars].length,this.attached_atom[_progress_bars].length){const t=this.attached_atom[_progress_bars][this.attached_atom[_progress_bars].length-1];t.c.ProgressBar.offset_y?this.offset_y=t.c.ProgressBar.offset_y+PROGRESSBAR_HEIGHT:this.offset_y=this.target_offset_y}else this.offset_y=this.target_offset_y;this.attached_atom[_progress_bars].push(this.atom)}this.last_timestamp=t}get_plane_id(){if(this.attached_atom)return this.attached_atom.get_plane_id()}get_displacement(t){if(this.update_offset(t),this.attached_atom){const s=this.attached_atom.get_displacement(t);return s.dispy+=this.offset_y,s}return null}on_render_tick(t,s){this.update_offset(s);const e=(s-(this.time_begin+this.atom.client.server_time_to_client))/this.delay;this.atom.icon_state=`prog_bar_${Math.max(0,Math.min(100,5*Math.round(20*e)))}`,this.atom.icon=`icons/effects/progressbar/${this.atom.icon_state}.png`,t()}destroy(){if(super.destroy(),this.attached_atom&&this.attached_atom[_progress_bars]){const t=this.attached_atom[_progress_bars],s=t.indexOf(this.atom);if(-1!==s){t.splice(s,1);for(let e=s;e<t.length;e++)t[e].components.ProgressBar.target_offset_y-=PROGRESSBAR_HEIGHT}}}}module.exports.components={ProgressBar:ProgressBar};

},{"../client/index.js":1}],20:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{Component:Component,chain_func:chain_func}=require("../client/index.js");class Projectile extends Component{constructor(t,e){super(t,e),this.a.get_transform=chain_func(this.a.get_transform,this.get_transform.bind(this)),this.a.get_displacement=chain_func(this.a.get_displacement,this.get_displacement.bind(this))}get_transform(t){return t().rotate((this.angle-90)*Math.PI/180)}get_displacement(t,e){const s=e-this.a.client.server_time_to_client-this.last_process;let n=this.a.x,i=this.a.y;const a=this.speed*s/1e3,c=this.angle*Math.PI/180;return{dispx:n+=Math.cos(c)*a,dispy:i+=Math.sin(c)*a}}}module.exports.components={Projectile:Projectile};

},{"../client/index.js":1}],21:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{Component:Component,chain_func:chain_func}=require("../client/index.js");class SplashScreen extends Component{constructor(e,t){super(e,t),this.fading=!1,this.fade_start=0,this.fade_len=1500,this.a.del=chain_func(this.a.del,this.del.bind(this)),this.a.on_render_tick=chain_func(this.a.on_render_tick,this.on_render_tick.bind(this)),this.a.draw=chain_func(this.a.draw,this.draw.bind(this))}on_render_tick(e){e(),this.fading&&this.a.mark_dirty()}draw(e,t,n){const i=t.globalAlpha;this.fading&&(t.globalAlpha*=1-1/this.fade_len*(n-this.fade_start)),e(),t.globalAlpha=i}del(e){this.fading=!0,this.fade_start=performance.now(),setTimeout(e,this.fade_len)}}module.exports.components={SplashScreen:SplashScreen};

},{"../client/index.js":1}],22:[function(require,module,exports){
(function (global){(function (){
"use strict";module.exports.now=function(e){global.is_bs_editor_env&&(module.exports=e),window.addEventListener("load",()=>{const t=document.getElementById("main-text-input");document.addEventListener("keydown",n=>{"input"!==n.target.localName&&e.connection&&("o"===n.key?(t.dataset.inputting="ooc",t.disabled=!1,t.focus(),n.preventDefault()):"t"===n.key&&(t.dataset.inputting="say",t.disabled=!1,t.focus(),n.preventDefault()))}),t.parentElement.addEventListener("click",e=>{if(!e.defaultPrevented){t.blur();const e=document.createElement("div");e.textContent="Use 'o' for OOC, and 't' for speech.";const n=document.getElementById("chatwindow");let i=!1;n.scrollTop+n.clientHeight>=n.scrollHeight&&(i=!0),n.appendChild(e),i&&(n.scrollTop=n.scrollHeight-n.clientHeight)}}),t.addEventListener("keydown",n=>{"Escape"===n.key?(t.blur(),t.dataset.inputting=null,t.value="",t.disabled=!0,n.preventDefault()):"Enter"===n.key&&(e.connection&&"ooc"===t.dataset.inputting?e.connection.send(JSON.stringify({ooc_message:t.value})):e.connection&&"say"===t.dataset.inputting&&e.connection.send(JSON.stringify({say_message:t.value})),t.blur(),t.dataset.inputting=null,t.value="",t.disabled=!0,n.preventDefault())}),t.addEventListener("input",()=>{t.value.startsWith(";")?t.classList.add("radio"):t.classList.remove("radio")})})};

}).call(this)}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],23:[function(require,module,exports){
"use strict";class AdminPanel{constructor(t){this.panel=t,this.panel.on("message",this.message_handler.bind(this)),this.panel.content_obj.innerHTML='\n<input type="text" placeholder="Search..." class="button search-field">\n<div class=\'tools-list\'>\n</div>\n',this.panel.$(".search-field").addEventListener("input",t=>{const e=t.target.value;for(const t of this.panel.$$(".tool-entry"))t.dataset.searchString.includes(e)?t.style.display="block":t.style.display="none"})}message_handler(t){t.tools&&(this.tools=t.tools,this.populate_tools())}populate_tools(){for(const[t,e]of Object.entries(this.tools).sort((t,e)=>{const s=t,n=e,o=s[1].name===n[1].name?0:-1;return s[1].name>n[1].name?1:o})){const s=e,n=document.createElement("div");n.classList.add("tool-entry"),n.style.borderBottom="1px solid grey",n.innerHTML=`\n<div style='font-weight:bold'>${s.name}</div>\n<div><i>${s.desc||""}</i></div>\n<div class='buttons'></div>\n`,n.dataset.searchString=t+s.name,this.panel.$(".tools-list").appendChild(n);const o=n.querySelector(".buttons");for(const e of s.buttons){const s=document.createElement("div");s.classList.add("button"),s.textContent=e,s.dataset.message=JSON.stringify({button_tool:t,button:e}),o.appendChild(s)}}}}module.exports.panel_classes={AdminPanel:AdminPanel};

},{}],24:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const ReagentBinding=require("./reagent_binding.js");class ChemDispenserPanel{constructor(e){this.panel=e,this.panel.on("message",this.handle_message.bind(this)),this.dispense_list_container=document.createElement("div"),this.dispense_list_container.classList.add("status-display"),this.panel.content_obj.appendChild(this.dispense_list_container),this.dispense_amounts=document.createElement("div"),this.dispense_list_container.appendChild(this.dispense_amounts),this.dispense_list=document.createElement("div"),this.dispense_list_container.appendChild(this.dispense_list),this.reagents_list_container=document.createElement("div"),this.reagents_list_container.classList.add("status-display"),this.reagents_list_container.innerHTML="\n<div class='has-no-container' style='color:red'>No container loaded</div>\n<div class='has-container'>\n\t<div class='button float-right' data-message='{\"eject\": true}'>Eject</div>\n\t<div class='float-right'><span class='total-volume'></span> / <span class='maximum-volume'></span></div>\n\t<div class='reagents-list'></div>\n</div>\n",this.panel.content_obj.appendChild(this.reagents_list_container),this.reagent_binding=new ReagentBinding(this.panel,this.reagents_list_container);for(const e of[1,5,10,15,20,25,30,40,50,75,100,150,300]){const s=document.createElement("div");s.classList.add("button"),s.dataset.radioGroup="dispense_amount",s.dataset.radioValue=e,s.innerText=`${e}`,this.dispense_amounts.appendChild(s)}}handle_message(e){if(e.dispensable_reagents){this.dispense_list.innerHTML="",e.dispensable_reagents.sort();for(const[s,t]of e.dispensable_reagents){const e=document.createElement("div");e.classList.add("button"),e.style.width="125px",e.style.margin="2px 0",e.innerText=t,e.dataset.message=JSON.stringify({dispense:s}),this.dispense_list.appendChild(e)}}if(e.dispense_amount&&e.dispense_amount!==this.dispense_amount){this.dispense_amount=e.dispense_amount;for(const e of this.dispense_amounts.childNodes)e.dataset.radioValue===this.dispense_amount?e.classList.add("selected"):e.classList.remove("selected")}}}module.exports.panel_classes={ChemDispenserPanel:ChemDispenserPanel};

},{"./reagent_binding.js":30}],25:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class LatejoinPanel{constructor(e){this.panel=e,this.panel.on("message",this.handle_message.bind(this)),this.panel.header_obj.classList.add("center"),this.panel.content_obj.classList.add("flex-vertical","wrap"),this.job_elems={},this.jobs={},this.department_elems={};for(const e of Object.keys(departments)){const{name:t,color:s}=departments[e],n=document.createElement("fieldset");n.classList.add("status-display","center");const o=document.createElement("legend");o.style.color=s,o.textContent=t,n.appendChild(o),this.panel.content_obj.appendChild(n),this.department_elems[e]=n}}handle_message(e){if(e.jobs)for(const t of Object.keys(e.jobs)){const s=this.jobs[t]||{};Object.assign(s,e.jobs[t]);let n=this.job_elems[t];if(!n){n=document.createElement("div"),this.job_elems[t]=n;const e=document.createElement("div");e.classList.add("button"),e.dataset.message=JSON.stringify({join:t});const o=this.department_elems[s.departments[0]||"misc"];s.departments.lastIndexOf("command")>0?(e.style.fontWeight="bold",o.insertBefore(n,o.firstChild)):o.appendChild(n),n.appendChild(e),n.button=e}n.button.textContent=`${s.title} (${s.current_positions}/${-1!==s.total_positions?s.total_positions:"∞"})`,s.current_positions>=s.total_positions&&-1!==s.total_positions?n.style.display="none":n.style.display="block"}}}const departments={misc:{name:"Miscellaneous",color:"#ffffff"}};module.exports.panel_classes={LatejoinPanel:LatejoinPanel};

},{}],26:[function(require,module,exports){
(function (global){(function (){
"use strict";class LoginPanel{constructor(e){this.panel=e,this.panel.content_obj.classList.add("center"),this.panel.header_obj.classList.add("center"),this.connection=e.manager.client.connection,this.message_handler=this.message_handler.bind(this),this.connection.addEventListener("message",this.message_handler)}message_handler(e){const n=JSON.parse(e.data);if(n.min_client_version){let e=global.client_version;e=e.replace(".","");const t=Number(e);let s=n.min_client_version;if(s=s.replace(".",""),t>=Number(s))console.info(`Client is running version ${global.client_version}.`);else{console.error(`Outdated client! This client has version ${global.client_version} and the server requires ${n.min_client_version} or newer.`),this.panel.container_obj.style.height="200px";const e=document.createElement("div");e.classList.add("vertical-margins");const t=document.createElement("P");t.innerHTML=`Outdated client! This client has version <b>${global.client_version}</b> and the server requires <b>${n.min_client_version}</b> or newer.`,e.appendChild(t),this.panel.content_obj.appendChild(e),this.connection.removeEventListener("message",this.message_handler)}}else if("debug"===n.login_type){let e=document.createElement("div");e.classList.add("vertical-margins");const n=document.createElement("input");n.type="text",n.maxLength=30,n.value=localStorage.getItem("debug_username"),n.placeholder="Nickname",e.appendChild(n),this.panel.content_obj.appendChild(e),(e=document.createElement("div")).classList.add("vertical-margins");const t=document.createElement("div");t.classList.add("button"),t.textContent="Connect",t.addEventListener("click",()=>{localStorage.setItem("debug_username",n.value),this.connection.send(JSON.stringify({login:n.value})),this.login_finish()}),e.appendChild(t),this.panel.content_obj.appendChild(e)}else if(!0===n.valid)n.autojoin&&(this.connection.send(JSON.stringify({login:n.logged_in_as})),this.login_finish());else if("database"===n.login_type){const e=document.createElement("div");e.classList.add("vertical-margins");const t=document.createElement("input");t.type="text",t.maxLength=30,t.placeholder="Username",t.value=localStorage.getItem("stored_username"),e.appendChild(t);const s=document.createElement("p");e.appendChild(s);const i=document.createElement("input");i.type="password",i.maxLength=30,i.placeholder="Password",i.value=localStorage.getItem("stored_password"),e.appendChild(i);const a=document.createElement("p");e.appendChild(a);const l=document.createElement("div");l.classList.add("button"),l.textContent="Login",l.addEventListener("click",()=>{this.connection.send(JSON.stringify({name:t.value,password:i.value,request_check:!0})),localStorage.setItem("stored_username",t.value)}),e.appendChild(l),this.panel.content_obj.appendChild(e),!0===n.value&&n.logged_in_as===t.value&&(this.connection.send(JSON.stringify({login:t.value})),this.login_finish())}else this.panel.content_obj.getElementsByClassName("logged-in")[0].style.display="none",this.panel.content_obj.getElementsByClassName("not-logged-in")[0].style.display="block",this.panel.content_obj.getElementsByClassName("connect-button")[0].classList.add("disabled")}login_finish(){this.connection.removeEventListener("message",this.message_handler),this.panel.manager.client.login_finish(),this.panel.close()}}module.exports.panel_classes={LoginPanel:LoginPanel};

}).call(this)}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],27:[function(require,module,exports){
"use strict";class MachineWirePanel{constructor(t){this.panel=t,this.panel.on("message",this.handle_message.bind(this)),this.panel.content_obj.innerHTML="\n\t\t\t<div class='status-display wires_list'>\n\n\t\t\t</div>\n\t\t\t<div class='status-display status_text' style='display: none'>\n\n\t\t\t</div>\n\t\t"}handle_message(t){if(t.wires)for(const e of t.wires){if(!this.panel.$(`.wire-color-${e.color}`)){const t=document.createElement("tr");t.classList.add("zebrastripe","flex","flex-horizontal",`wire-color-${e.color}`),t.innerHTML=`\n\t\t\t\t\t\t<span class='wire-color' style='color: ${e.color}'>${e.color}</span>\n\t\t\t\t\t\t<div class='button wire-pulse-button' style='margin-left: auto' data-message='{"pulse":"${e.color}"}' title="Requires multitool">Pulse</div>\n\t\t\t\t\t\t<div class='button wire-cut-button' data-message='{"cut":"${e.color}"}' title="Requires wirecutters"></div>\n\t\t\t\t\t`,this.panel.$(".wires_list").appendChild(t),"Multitool"!==this.item_type&&this.panel.$(`.wire-color-${e.color} .wire-pulse-button`).classList.add("disabled"),"Wirecutters"!==this.item_type&&this.panel.$(`.wire-color-${e.color} .wire-cut-button`).classList.add("disabled")}void 0!==e.cut&&(this.panel.$(`.wire-color-${e.color} .wire-cut-button`).textContent=e.cut?"Mend":"Cut")}this.handle_other_messages(t)}handle_other_messages(t){if(void 0!==t.item_type){this.item_type=t.item_type;for(const t of this.panel.$$(".wire-cut-button"))"Wirecutters"===this.item_type?t.classList.remove("disabled"):t.classList.add("disabled");for(const t of this.panel.$$(".wire-pulse-button"))"Multitool"===this.item_type?t.classList.remove("disabled"):t.classList.add("disabled")}void 0!==t.status_text&&(void 0===t.status_text?this.panel.$(".status_text").style.display="none":this.panel.$(".status_text").style.display="block",this.panel.$(".status_text").innerHTML=t.status_text)}}module.exports.panel_classes={MachineWirePanel:MachineWirePanel};

},{}],28:[function(require,module,exports){
"use strict";class NewPlayerPanel{constructor(t){this.panel=t,this.panel.on("message",this.handle_message.bind(this)),this.build_content(),this.update_timer=this.update_timer.bind(this),this.update_timer()}handle_message(t){void 0!==t.latejoin&&([...this.panel.content_obj.getElementsByClassName("pregame")].forEach(e=>e.style.display=t.latejoin?"none":"block"),[...this.panel.content_obj.getElementsByClassName("latejoin")].forEach(e=>e.style.display=t.latejoin?"block":"none")),void 0!==t.start_at&&(this.start_at=t.start_at,this.update_timer())}update_timer(){if(this.timer_timeout=setTimeout(this.update_timer,50),void 0===this.start_at)this.panel.$(".timer").textContent="Delayed";else{const t=this.start_at-(performance.now()-this.panel.manager.client.server_time_to_client);this.panel.$(".timer").textContent=t<0?"SOON":(t/1e3).toFixed(1)}}build_content(){this.panel.header_obj.classList.add("center"),this.panel.content_obj.classList.add("center"),this.panel.content_obj.innerHTML="\n\t\t\t<div class=\"vertical-margins\"><div class='button' data-message='{\"setup_character\":true}'>Character & Preferences</div></div>\n\t\t\t<div class=\"pregame vertical-margins\">\n\t\t\t\tStarting in: <span class='timer'></span>\n\t\t\t</div>\n\t\t\t<div class=\"latejoin vertical-margins\"><div class='button' data-message='{\"latejoin\":true}'>Join Game</div></div>\n\t\t\t<div class=\"vertical-margins\"><div class='button' data-message='{\"observe\":true}'>Observe</div></div>\n\t\t"}}module.exports.panel_classes={NewPlayerPanel:NewPlayerPanel};

},{}],29:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{Atom:Atom,dropdown:dropdown}=require("../../client/index.js"),job_pref_settings=["NEVER","Low","Medium","High"],job_pref_colors=["red","orange","green","slateblue"];class PreferencesPanel{constructor(e){this.panel=e,this.panel.header_obj.classList.add("center"),this.panel.content_obj.innerHTML="\n<div class='center'>\n\t<div class='button' data-radio-group='tab' data-tab='character'>Character Setup</div>\n\t<div class='button' data-radio-group='tab' data-tab='job-preferences'>Job Preferences</div>\n\t<div class='button' data-radio-group='tab' data-tab='preferences'>Preferences</div>\n</div>\n<hr>\n<div class='tabcontent' style='display: none' data-tab='character'>\n\n<div class='status-display float-right' style='width:128px;height:128px;margin-left: 10;padding:0;position:relative'>\n\t<canvas class='preview-down' style='width:64px; position:absolute; top:0;left:0'></canvas>\n\t<canvas class='preview-right' style='width:64px; position:absolute; top:0;right:0'></canvas>\n\t<canvas class='preview-up' style='width:64px; position:absolute; bottom:0;left:0'></canvas>\n\t<canvas class='preview-left' style='width:64px; position:absolute; bottom:0;right:0'></canvas>\n</div>\n<div class='status-display'>\n\t<h2>Identity</h2>\n\t<div><div class='button property-be_random_name'>Always Random Name</div></div>\n\t<table>\n\t<tr>\n\t\t<td>Name:</td>\n\t\t<td><input type='text' class='button nopress nocenter property-name' maxlength=42></td>\n\t\t<td><div class='button yellow' data-message='{\"randomize_name\":\"human\"}'>Random</div></td>\n\t</tr>\n\t<tr>\n\t\t<td>Gender:</td>\n\t\t<td><div class='button property-gender dropdown'>Male</div></td>\n\t</tr>\n\t<tr>\n\t\t<td>Age:</td>\n\t\t<td><input class='button nopress nocenter property-age' type='number' min=17 max=85></td>\n\t</tr>\n\t</table>\n</div>\n\n<div class='status-display'>\n\t<h2>Body</h2>\n\t<div class='flex-horizontal wrap appearance-properties-container'>\n\t\t<div>\n\t\t\t<h3>Skin Tone</h3>\n\t\t\t<div><div class='button property-skin_tone dropdown'>caucasian2</div></div>\n\t\t</div>\n\t\t<div>\n\t\t\t<h3>Hair Style</h3>\n\t\t\t<div><div class='button property-hair dropdown'>Bald</div></div>\n\t\t\t<div><div class='button property-hair_color dropdown'>Color</div></div>\n\t\t</div>\n\t</div>\n</div>\n\n</div>\n<div class='tabcontent' style='display: none' data-tab='job-preferences'>\n\n<div class='job-list' style='color: #000000;display:grid;grid-auto-flow:column'></div>\n\n</div>\n<div class='tabcontent' style='display: none' data-tab='preferences'>\n\n<input type=\"range\" min=\"1\" max=\"16\" step=\"1\" class=\"shadow-quality-slider\" value=8>\n\n</div>",[...this.panel.$$('.button[data-radio-group="tab"]')].forEach(e=>{e.addEventListener("click",()=>{this.show_tab(e.dataset.tab)})});const t=this.panel.$(".property-name");t.addEventListener("input",()=>{this.panel.send_message({char_prefs:{name:t.value}})});const s=this.panel.$(".property-gender");s.addEventListener("click",e=>{if(e.defaultPrevented)return;const t={male:"Male",female:"Female"},n=document.createElement("div");n.classList.add("dropdown-content");for(const[e,a]of Object.entries(t)){const t=document.createElement("div");t.classList.add("button","dropdown-item"),e===this.char_prefs.gender&&t.classList.add("selected"),t.textContent=a,t.addEventListener("click",t=>{this.panel.send_message({char_prefs:{gender:e}}),t.preventDefault(),this.char_prefs.gender=e,s.textContent=a,this.update_previews()}),n.appendChild(t)}dropdown(s,n)});const n=this.panel.$(".property-hair");n.addEventListener("click",e=>{if(e.defaultPrevented)return;const t=document.createElement("div");t.classList.add("dropdown-content");let s=null;for(const[e,a]of Object.entries(this.sprite_accessories.hair)){const r=a,o=document.createElement("div");o.classList.add("button","dropdown-item"),o.style.height="64px",e===this.char_prefs.hair_style&&(o.classList.add("selected"),s=o);const i=document.createElement("span");i.textContent=r.name;const d=this.create_preview({prefs_modifier:t=>{t.hair_style=e}});d.style.float="left",d.style.height="64px",o.appendChild(d),o.appendChild(i),o.addEventListener("click",t=>{this.panel.send_message({char_prefs:{hair_style:e}}),t.preventDefault(),this.char_prefs.hair_style=e,n.textContent=r.name,this.update_previews()}),t.appendChild(o)}dropdown(n,t),s&&s.scrollIntoView({behavior:"auto"})});const a=this.panel.$(".property-skin_tone");a.addEventListener("click",e=>{if(e.defaultPrevented)return;const t=document.createElement("div");t.classList.add("dropdown-content");let s=null;for(const e of Object.keys(this.skin_tones)){const n=document.createElement("div");n.classList.add("button","dropdown-item"),n.style.height="64px",e===this.char_prefs.skin_tone&&(n.classList.add("selected"),s=n);const r=document.createElement("span");r.textContent=e;const o=this.create_preview({prefs_modifier:t=>{t.skin_tone=e}});o.style.float="left",o.style.height="64px",n.appendChild(o),n.appendChild(r),n.addEventListener("click",t=>{this.panel.send_message({char_prefs:{skin_tone:e}}),t.preventDefault(),this.char_prefs.skin_tone=e,a.textContent=e,this.update_previews()}),t.appendChild(n)}dropdown(a,t),s&&s.scrollIntoView({behavior:"auto"})});const r=this.panel.$(".property-hair_color");r.addEventListener("click",e=>{if(e.defaultPrevented)return;const t=document.createElement("div");t.classList.add("dropdown-content");let s=null;for(const e of Object.keys(this.hair_colors)){const n=document.createElement("div");n.classList.add("button","dropdown-item"),n.style.width="96px",n.style.height="24px",n.style.backgroundColor=this.hair_colors[e],this.hair_colors[e]===this.char_prefs.hair_color&&(n.classList.add("selected"),s=n);const a=document.createElement("span");a.textContent=e,n.appendChild(a),n.addEventListener("click",t=>{this.panel.send_message({char_prefs:{hair_color:this.hair_colors[e]}}),t.preventDefault(),this.char_prefs.hair_color=this.hair_colors[e],r.textContent=e,r.style.backgroundColor=this.char_prefs.hair_color,this.update_previews()}),t.appendChild(n)}dropdown(r,t),s&&s.scrollIntoView({behavior:"auto"})}),this.panel.$(".property-age").addEventListener("input",e=>{const t=Math.round(+e.target.value);this.panel.send_message({char_prefs:{age:t}})});const o=this.panel.$(".shadow-quality-slider");o.value=this.panel.manager.client.soft_shadow_resolution,o.addEventListener("input",()=>{const e=+o.value;this.panel.manager.client.soft_shadow_resolution=e,localStorage.setItem("shadow_resolution",String(e));for(const e of this.panel.manager.client.atoms)e&&e.c&&e.c.LightingObject&&e.mark_dirty()}),this.panel.on("message",this.handle_message.bind(this)),this.char_prefs={}}show_tab(e){[...this.panel.$$(".tabcontent")].forEach(e=>{e.style.display="none"});const t=this.panel.$(`.tabcontent[data-tab='${e}']`);t&&(t.style.display="block")}msg_char_prefs(e){Object.assign(this.char_prefs,e.char_prefs),e.char_prefs.name&&(this.panel.$(".property-name").value=e.char_prefs.name),e.char_prefs.gender&&(this.panel.$(".property-gender").textContent="male"===e.char_prefs.gender?"Male":"Female"),e.char_prefs.age&&(this.panel.$(".property-age").value=e.char_prefs.age),e.char_prefs.skin_tone&&(this.panel.$(".property-skin_tone").textContent=e.char_prefs.skin_tone),e.char_prefs.hair_color&&(this.panel.$(".property-hair_color").style.backgroundColor=e.char_prefs.hair_color),e.char_prefs.hair_style&&(this.panel.$(".property-hair").textContent=this.sprite_accessories.hair[e.char_prefs.hair_style].name),this.update_previews()}handle_message(e){if(e.sprite_accessories&&(this.sprite_accessories=e.sprite_accessories),e.skin_tones&&(this.skin_tones=e.skin_tones),e.hair_colors&&(this.hair_colors=e.hair_colors),e.set_tab&&([...this.panel.$$(".button[data-radio-group='tab']")].forEach(e=>{e.classList.remove("selected")}),this.panel.$(`.button[data-radio-group='tab'][data-tab='${e.set_tab}']`).classList.add("selected"),this.show_tab(e.set_tab)),e.char_prefs&&this.msg_char_prefs(e),Object.prototype.hasOwnProperty.call(e,"name_valid")){const t=this.panel.$(".property-name");e.name_valid?t.classList.remove("red"):t.classList.add("red")}if(e.name_correction){const t=this.panel.$(".property-name");t.value===e.name_correction[0]&&(t.value=e.name_correction[1])}e.job_preferences&&this.handle_prefs(e)}handle_prefs(e){this.job_preferences=e.job_preferences,e.job_metas&&(this.job_metas=e.job_metas);const t=[...Object.keys(this.job_metas)];t.sort((e,t)=>{const s=this.job_metas[e],n=this.job_metas[t],a=department_order.indexOf(s.departments[0]||"misc")-department_order.indexOf(n.departments[0]||"misc");return 0!==a?a:s.departments.includes("command")&&!n.departments.includes("command")?-1:!s.departments.includes("command")&&n.departments.includes("command")?1:0}),this.panel.$(".job-list").style.gridTemplateRows=`repeat(${Math.ceil(t.length/2)}, auto)`;for(const e of t){const t=this.job_metas[e],s=document.createElement("div");s.style.minWidth="280",s.style.backgroundColor=t.selection_color,s.dataset.jobKey=e;const n=this.job_preferences[e];s.innerHTML=`\n<div style='text-align:right;width:180;display:inline-block;padding-right:3px'>${t.name}</div>\n<div style='display:inline-block' class='job-pref-button-container'></div>`;const a=s.querySelector(".job-pref-button-container"),r=document.createElement("div");a.appendChild(r),r.classList.add("button","dropdown","white","job-selection-button"),"nomad"===e?this.do_nomad_job(e,n,r):this.do_other_job(e,n,r),this.panel.$(".job-list").appendChild(s)}}do_other_job(e,t,s){s.style.visibility="hidden",s.classList.add("affected-by-assistant"),s.style.color=job_pref_colors[t],s.textContent=job_pref_settings[t],s.addEventListener("click",t=>{if(t.defaultPrevented)return;const n=document.createElement("div");n.classList.add("dropdown-content");for(let t=0;t<=3;t++){const a=document.createElement("div");a.classList.add("button","dropdown-item","white"),t===this.job_preferences[e]&&a.classList.add("selected"),a.textContent=job_pref_settings[t],a.style.color=job_pref_colors[t],a.addEventListener("click",n=>{if(this.panel.send_message({job_preferences:{[e]:t}}),n.preventDefault(),s.textContent=job_pref_settings[t],s.style.color=job_pref_colors[t],this.job_preferences[e]=t,3===t)for(const[t,s]of Object.entries(this.job_preferences))if(3===s&&t!==e){this.job_preferences[t]=2;const e=this.panel.$(`.job-list div[data-job-key="${t}"] .job-selection-button`);e&&(e.textContent=job_pref_settings[2],e.style.color=job_pref_colors[2])}}),n.appendChild(a)}dropdown(s,n)})}do_nomad_job(e,t,s){t?(s.style.color="green",s.textContent="Yes"):(s.style.color="red",s.textContent="No")}update_previews(){this.create_preview({canvas:this.panel.$(".preview-down"),dir:1}),this.create_preview({canvas:this.panel.$(".preview-right"),dir:3}),this.create_preview({canvas:this.panel.$(".preview-up"),dir:2}),this.create_preview({canvas:this.panel.$(".preview-left"),dir:4})}create_preview({canvas:e=null,dir:t=1,modifier:s=null,prefs_modifier:n=null}={}){const a=new Atom(this.panel.manager.client,{dir:t}),r=JSON.parse(JSON.stringify(this.char_prefs));n&&n(r);for(const e of["torso","groin","l_arm","r_arm","l_leg","r_leg","r_hand","l_hand","r_foot","l_foot","head"]){let s=e,n=e;s+="female"===r.gender?"_f":"_m",n+="female"===r.gender?"_f":"_m";let o=null;this.skin_tones&&(o=this.skin_tones[r.skin_tone]),a.set_overlay(`limb_${e}`,{icon:`icons/mob/human_body/${n}/${n}-dir${t}.png`,icon_state:s,color:o})}const o=this.sprite_accessories.hair[r.hair_style];o&&a.set_overlay("hair",{icon:`${o.base_icon}/${o.icon_state}-dir${t}.png`,icon_state:o.icon_state,color:this.char_prefs.hair_color,overlay_layer:14}),s&&s(a),e||(e=document.createElement("canvas")),e.width=32,e.height=32;let i=performance.now();return a.on_render_tick(i),a.fully_load().then(()=>{i=performance.now(),a.on_render_tick(i);const t=e.getContext("2d");t.clearRect(0,0,e.width,e.height),a.draw(t,i),a.del()}),e}}const department_order=["misc","command","supply","service","eng","med","sci","sec","synth"];module.exports.now=(e=>{const t=localStorage.getItem("shadow_resolution");void 0!==t&&(e.soft_shadow_resolution=+t)}),module.exports.panel_classes={PreferencesPanel:PreferencesPanel};

},{"../../client/index.js":1}],30:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class ReagentBinding{constructor(e,t,s){Object.assign(this,{path:"beaker"},s),this.elem=t,this.message_handler=this.message_handler.bind(this),this.panel=e,this.reagent_elems={},this.panel.on("message",this.message_handler);for(const e of this.elem.querySelectorAll(".has-container"))e.style.display="none";for(const e of this.elem.querySelectorAll(".has-no-container"))e.style.display="visible"}message_handler(e){for(const t of this.path.split(".")){if(!e||!Object.prototype.hasOwnProperty.call(e,t))return;e=e[t]}e?this.handle_obj_message(e):this.handle_no_obj_message()}handle_no_obj_message(){for(const e of this.elem.querySelectorAll(".has-container"))e.style.display="none";for(const e of this.elem.querySelectorAll(".has-no-container"))e.style.display=null;for(const e of Object.values(this.reagent_elems))e&&this.elem.querySelector(".reagents-list").removeChild(e);this.reagent_elems={}}handle_obj_message(e){for(const e of this.elem.querySelectorAll(".has-container"))e.style.display=null;for(const e of this.elem.querySelectorAll(".has-no-container"))e.style.display="none";void 0!==e.temperature&&[...this.elem.querySelectorAll(".temperature")].forEach(t=>{t.textContent=+e.temperature.toFixed(1)}),void 0!==e.holder_name&&[...this.elem.querySelectorAll(".holder-name")].forEach(t=>{t.textContent=e.holder_name}),void 0!==e.total_volume&&[...this.elem.querySelectorAll(".total-volume")].forEach(t=>{t.textContent=e.total_volume}),void 0!==e.maximum_volume&&[...this.elem.querySelectorAll(".maximum-volume")].forEach(t=>{t.textContent=e.maximum_volume}),e.reagents&&this.check_reagents(e)}check_reagents(e){const t=this.elem.querySelector(".reagents-list");for(const[s,l]of Object.entries(e.reagents)){if(!l){this.reagent_elems[s]&&(t.removeChild(this.reagent_elems[s]),delete this.reagent_elems[s]);continue}let e=this.reagent_elems[s];e||(e=this.build_entry(),t.appendChild(e),this.reagent_elems[s]=e),this.update_entry(s,l,e)}}build_entry(){const e=document.createElement("div");return e.classList.add("zebrastripe"),e.style.padding="2px 0",e}update_entry(e,t,s){s.textContent=`${+t.volume.toFixed(2)} unit${1===t.volume?"":"s"} of ${t.name}`}close(){for(const e of this.elem.querySelectorAll(".has-container"))e.style.display="none";for(const e of this.elem.querySelectorAll(".has-no-container"))e.style.display="visible";this.panel.removeListener("message",this.message_handler)}}module.exports=ReagentBinding;

},{}],31:[function(require,module,exports){
"use strict";class ServerPanel{constructor(e){this.panel=e,this.panel.content_obj.classList.add("center"),this.panel.header_obj.classList.add("center"),this.connection=e.manager.client.connection,this.run()}run(){let e=document.createElement("div");e.classList.add("vertical-margins");const t=document.createElement("div");t.classList.add("button"),t.textContent="Local",t.addEventListener("click",()=>{this.panel.manager.client.resume_login("localhost"),this.panel.close()}),e.appendChild(t),this.panel.content_obj.appendChild(e),(e=document.createElement("div")).classList.add("vertical-margins");const n=document.createElement("div");n.classList.add("button"),n.textContent="civ13.com",n.addEventListener("click",()=>{this.panel.manager.client.resume_login("civ13.com"),this.panel.close()}),e.appendChild(n),this.panel.content_obj.appendChild(e)}}module.exports.panel_classes={ServerPanel:ServerPanel};

},{}],32:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{Atom:Atom}=require("../../client/index.js");class SpawnObjectPanel{constructor(e){this.panel=e,this.panel.on("message",this.message_handler.bind(this)),this.panel.content_obj.innerHTML='\n<input type="text" placeholder="Search..." class="button search-field">\n<div class=\'templates-list\'>\n</div>\n',this.panel.$(".search-field").addEventListener("input",e=>{const t=e.target.value;for(const e of this.panel.$$(".template-entry"))e.dataset.searchString.includes(t)?e.style.display="block":e.style.display="none"}),this.panel.content_obj.addEventListener("click",e=>{const t=e.target.closest(".spawn-button");if(t){const e=t.closest(".template-entry").dataset.templateKey;this.panel.send_message({spawn:e})}}),this.panel.manager.client.server_templates&&(this.templates=this.panel.manager.client.server_templates,this.populate_templates())}message_handler(e){e.templates&&(this.templates=e.templates,this.panel.manager.client.server_templates=e.templates,this.populate_templates())}populate_templates(){for(const[e,t]of Object.entries(this.templates).sort((e,t)=>{const s=e[0]===t[0]?0:-1;return e[0]>t[0]?1:s})){const s=e,n=t;if(void 0===n.tree_paths)continue;const a=document.createElement("div");a.classList.add("template-entry"),a.style.borderBottom="1px solid grey",a.innerHTML=`\n<canvas class='item-preview' width=32 height=32></canvas>\n<div><b>${n.vars.name}</b>&nbsp;(${s})</div>\n<div><i>${n.tree_paths}</i></div>\n<div class='button spawn-button' dataset-template>Spawn</div>\n`,a.dataset.templateKey=s,a.dataset.searchString=s+n.vars.name,this.panel.$(".templates-list").appendChild(a);const l=a.querySelector(".item-preview");setTimeout(()=>{const e=Object.assign({},n.vars);e.components=(n.components||[]).filter(e=>this.panel.manager.client.components[e]),e.component_vars=n.vars.components,n.vars.components&&n.vars.components.Tangible?e.directional=n.vars.components.Tangible.directional:e.directional=!1;const t=new Atom(this.panel.manager.client,e);t.on_render_tick(0),t.fully_load(e.directional).then(()=>{t.on_render_tick(0),t.draw(l.getContext("2d"),0),t.del()})},1)}}}module.exports.panel_classes={SpawnObjectPanel:SpawnObjectPanel};

},{"../../client/index.js":1}],33:[function(require,module,exports){
(function (global){(function (){
"use strict";class StackCraftPanel{constructor(e){this.panel=e,this.civilization=null,this.panel.on("message",this.handle_message.bind(this));const i=document.createElement("div");i.appendChild(document.createTextNode("amount: ")),i.appendChild(this.amount_node=document.createTextNode("")),this.panel.content_obj.appendChild(i),this.recipes_elem=document.createElement("div"),this.panel.content_obj.appendChild(this.recipes_elem)}handle_message(e){e.civilization&&(this.civilization=e.civilization),e.recipes&&(this.recipes=e.recipes,this.build_recipes()),e.amount&&(this.amount_node.textContent=e.amount),e.build_limit&&(this.recipes[e.build_limit.index].build_limit=e.build_limit.build_limit,this.build_recipe(e.build_limit.index))}build_recipes(){this.recipes_elem.innerHTML="";for(let e=0;e<this.recipes.length;e++){if(void 0===this.recipes[e])this.recipes_elem.appendChild(document.createElement("hr"));else{const i=document.createElement("div");i.classList.add("small-vertical-margins"),this.recipes_elem.appendChild(i),this.build_recipe(e)}}}build_recipe(e){const i=this.recipes_elem.childNodes[e];i.innerHTML&&(i.innerHTML="");const t=this.recipes[e],l=document.createElement("div");l.innerText=`${t.res_amount&&t.res_amount>1?`${t.res_amount}x `:""}${t.name} (costs ${t.cost})`,l.classList.add("button"),t.build_limit<=0&&l.classList.add("disabled"),l.dataset.message=JSON.stringify({build:e,amount:1}),i.appendChild(l)}recipe_check_tech(e){if(!(e.age1&&e.age2&&e.age2&&e.last_age))return 0;if(global.Tworld.age>e.last_age)return 0;if(void 0===this.civilization||""===this.civilization)return console.log("No civ"),global.Tworld.age1>=e.age1&&global.Tworld.age2>=e.age2&&global.Tworld.age3>=e.age3?1:0;if(console.log("Yes civ"),global.Tworld.civilizations[this.civilization]){const e=global.Tworld.civilizations[this.civilization];return e.research_ind>=global.Tworld.age1&&e.research_mil>=global.Tworld.age1&&e.research_hlt>=global.Tworld.age3?1:0}return 0}}module.exports.panel_classes={StackCraftPanel:StackCraftPanel};

}).call(this)}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],34:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const{Atom:Atom}=require("../../client/index.js");class StripPanel{constructor(t){this.panel=t,this.panel.on("message",this.handle_message.bind(this)),this.panel.content_obj.innerHTML="\n\t\t\t<table class='item-table'></table>\n\t\t",this.covered={},this.cached_appearances={}}handle_message(t){if(t.layout){const e=this.panel.$(".item-table");let s=0;for(const a of t.layout){const n=t.layout_names[s];s++;const i=document.createElement("tr");e.appendChild(i),void 0!==a?(i.dataset.slot=a,i.innerHTML=`\n<td>${n}</td>\n<td>\n\t<div class='button strip-button'>\n\t\t<canvas style='display:none;height:16px;float:left' width=32 height=32 class='item-appearance'></canvas>\n\t\t<span class='item-name'>Empty</span>\n\t</div>\n</td>\n<td><div class='button internals-button' style='display:none' data-message="${JSON.stringify({slot_internals:a})}">Disable Internals</div></td>\n\t\t\t\t`,i.querySelector(".strip-button").dataset.message=JSON.stringify({slot:a})):i.innerHTML="<td colspan=3>&nbsp;</td>"}}if(t.covered)for(const[e,s]of Object.entries(t.covered)){if(!this.panel.$(`tr[data-slot=${e}]`))continue;this.covered[e]=s;const t=this.panel.$(`tr[data-slot=${e}] .item-name`),a=this.panel.$(`tr[data-slot=${e}] .strip-button`);s?(t.textContent="Obscured",a.classList.add("disabled"),a.style.color="inherit"):a.classList.remove("disabled")}if(t.item_names)for(const[e,s]of Object.entries(t.item_names))this.panel.$(`tr[data-slot=${e}]`)&&(this.covered[e]||(this.panel.$(`tr[data-slot=${e}] .item-name`).textContent=s||"Empty",this.panel.$(`tr[data-slot=${e}] .strip-button`).style.color=s?"inherit":"grey"));if(t.item_appearances)for(const[e,s]of Object.entries(t.item_appearances)){if(!this.panel.$(`tr[data-slot=${e}]`))continue;const t=this.panel.$(`tr[data-slot=${e}] .item-appearance`),a=!this.cached_appearances[e];if(this.cached_appearances[e]=s,s){t.style.display="inline-block";const n=t.getContext("2d"),i=new Atom(this.panel.manager.client,s);a&&n.clearRect(0,0,32,32),i.on_render_tick(0),i.fully_load().then(()=>{s===this.cached_appearances[e]&&(n.clearRect(0,0,32,32),i.on_render_tick(0),i.draw(n,0)),i.del()})}else t.style.display="none"}}}module.exports.panel_classes={StripPanel:StripPanel};

},{"../../client/index.js":1}],35:[function(require,module,exports){
(function (global){(function (){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const TypespessClient=require("./client/index.js"),{Eye:Eye,Plane:Plane}=TypespessClient,{ParallaxPlane:ParallaxPlane}=require("./code/parallax.js");for(const e of[HTMLCollection,NodeList,DOMTokenList])e.prototype[Symbol.iterator]||(e.prototype[Symbol.iterator]=Array.prototype[Symbol.iterator]);global.client_version="0.1.0";const client=new TypespessClient;client.importModule(require("./code/alert.js")),client.importModule(require("./code/carbon_mob.js")),client.importModule(require("./code/hud.js")),client.importModule(require("./code/progress_bar.js")),client.importModule(require("./code/projectile.js")),client.importModule(require("./code/splash_screen.js")),client.importModule(require("./code/text_input.js")),client.importModule(require("./code/ui/admin_menu.js")),client.importModule(require("./code/ui/chem_dispenser.js")),client.importModule(require("./code/ui/latejoin.js")),client.importModule(require("./code/ui/login.js")),client.importModule(require("./code/ui/server.js")),client.importModule(require("./code/ui/machine_wires.js")),client.importModule(require("./code/ui/new_player.js")),client.importModule(require("./code/ui/preferences.js")),client.importModule(require("./code/ui/spawn_object.js")),client.importModule(require("./code/ui/stack_craft.js")),client.importModule(require("./code/ui/strip.js")),global.is_bs_editor_env?module.exports=client:(client.handle_login=function(){this.panel_manager.create_client_panel({title:"Login",can_close:!1,content_class:"LoginPanel",width:250,height:400})},require("./code/preload.js")(client),window.addEventListener("load",()=>{const e=new Eye(client,"");new Plane.World(e,"").z_index=0,new Plane(e,"ui").z_index=1e4,new Plane.Lighting(e,"lighting").z_index=5e3,new ParallaxPlane(e,"parallax").z_index=9999,e.canvas=document.getElementById("mainlayer"),e.create_click_handlers(),e.on("mouse_over_atom_changed",e=>{const i=document.getElementById("hovering-atom");i&&(i.textContent=e?e.name:"")}),client.login()}));

}).call(this)}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./client/index.js":1,"./code/alert.js":14,"./code/carbon_mob.js":15,"./code/hud.js":16,"./code/parallax.js":17,"./code/preload.js":18,"./code/progress_bar.js":19,"./code/projectile.js":20,"./code/splash_screen.js":21,"./code/text_input.js":22,"./code/ui/admin_menu.js":23,"./code/ui/chem_dispenser.js":24,"./code/ui/latejoin.js":25,"./code/ui/login.js":26,"./code/ui/machine_wires.js":27,"./code/ui/new_player.js":28,"./code/ui/preferences.js":29,"./code/ui/server.js":31,"./code/ui/spawn_object.js":32,"./code/ui/stack_craft.js":33,"./code/ui/strip.js":34}],36:[function(require,module,exports){
"use strict";var ReflectOwnKeys,R="object"==typeof Reflect?Reflect:null,ReflectApply=R&&"function"==typeof R.apply?R.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};function ProcessEmitWarning(e){console&&console.warn&&console.warn(e)}ReflectOwnKeys=R&&"function"==typeof R.ownKeys?R.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var NumberIsNaN=Number.isNaN||function(e){return e!=e};function EventEmitter(){EventEmitter.init.call(this)}module.exports=EventEmitter,module.exports.once=once,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._eventsCount=0,EventEmitter.prototype._maxListeners=void 0;var defaultMaxListeners=10;function checkListener(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function _getMaxListeners(e){return void 0===e._maxListeners?EventEmitter.defaultMaxListeners:e._maxListeners}function _addListener(e,t,n,r){var i,o,s;if(checkListener(n),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),s=o[t]),void 0===s)s=o[t]=n,++e._eventsCount;else if("function"==typeof s?s=o[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),(i=_getMaxListeners(e))>0&&s.length>i&&!s.warned){s.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=s.length,ProcessEmitWarning(u)}return e}function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=onceWrapper.bind(r);return i.listener=n,r.wrapFn=i,i}function _listeners(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?unwrapListeners(i):arrayClone(i,i.length)}function listenerCount(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function arrayClone(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function spliceOne(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function unwrapListeners(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}function once(e,t){return new Promise(function(n,r){function i(n){e.removeListener(t,o),r(n)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",i),n([].slice.call(arguments))}eventTargetAgnosticAddListener(e,t,o,{once:!0}),"error"!==t&&addErrorHandlerIfEventEmitter(e,i,{once:!0})})}function addErrorHandlerIfEventEmitter(e,t,n){"function"==typeof e.on&&eventTargetAgnosticAddListener(e,"error",t,n)}function eventTargetAgnosticAddListener(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function i(o){r.once&&e.removeEventListener(t,i),n(o)})}}Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(e){if("number"!=typeof e||e<0||NumberIsNaN(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");defaultMaxListeners=e}}),EventEmitter.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||NumberIsNaN(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},EventEmitter.prototype.getMaxListeners=function(){return _getMaxListeners(this)},EventEmitter.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,i=this._events;if(void 0!==i)r=r&&void 0===i.error;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var s=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw s.context=o,s}var u=i[e];if(void 0===u)return!1;if("function"==typeof u)ReflectApply(u,this,t);else{var f=u.length,v=arrayClone(u,f);for(n=0;n<f;++n)ReflectApply(v[n],this,t)}return!0},EventEmitter.prototype.addListener=function(e,t){return _addListener(this,e,t,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function(e,t){return _addListener(this,e,t,!0)},EventEmitter.prototype.once=function(e,t){return checkListener(t),this.on(e,_onceWrap(this,e,t)),this},EventEmitter.prototype.prependOnceListener=function(e,t){return checkListener(t),this.prependListener(e,_onceWrap(this,e,t)),this},EventEmitter.prototype.removeListener=function(e,t){var n,r,i,o,s;if(checkListener(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){s=n[o].listener,i=o;break}if(i<0)return this;0===i?n.shift():spliceOne(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,s||t)}return this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,o=Object.keys(n);for(r=0;r<o.length;++r)"removeListener"!==(i=o[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},EventEmitter.prototype.listeners=function(e){return _listeners(this,e,!0)},EventEmitter.prototype.rawListeners=function(e){return _listeners(this,e,!1)},EventEmitter.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):listenerCount.call(e,t)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]};

},{}]},{},[35]);
